{{header}}
<link rel="stylesheet" href="catalog\view\theme\so-mobile\stylesheet\home_diwali.css">

<!-- Add this after the header -->

{# <div class="so-subcategory-wrapper">
  {% for chunk in subcategories1|batch(6) %}
    <div class="so-subcategory-cards">
        {% for subcat in chunk %}
            <div class="so-card-link" onclick="window.location.href='{{ subcat.href }}'">
                <div class="so-card">
                    <div class="so-card-image">
                        <img src="{{ subcat.thumb }}" alt="{{ subcat.name }}">
                    </div>
                    <div class="so-card-body">
                        <div class="first-heading">
                            {{ subcat.name|length > 15 ? subcat.name|slice(0, 13) ~ '..' : subcat.name }}
                        </div>
                        <div class="so-price">From ‚Çπ{{ subcat.price }}</div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
  {% endfor %}
</div> #}







<div class="home-diwali-section">
<div class="festival-wrapper">
  <a href="{{ First_banner_link }}">
    <img src="{{ First_banner }}" alt="Diwali Offer" class="banner-img">
  </a>
</div>


{% if catgeory and catgeory|length %}
 <div class="diwali-first-title">
    üéÜ Diwali Dhamaka Offers üéÜ
  </div>
<div class="diwali-category-section">


  <div class="diwali-category-row">
    {% for cat in catgeory %}
      <a href="{{ cat.href }}" class="diwali-category-card">
        <div class="diwali-card-glow"></div>
        <div class="diwali-card-inner">
          <img src="{{ cat.thumb }}" alt="{{ cat.name }}" loading="lazy">
          <div class="diwali-category-title">
            {{ cat.name|length > 15 ? cat.name|slice(0, 13) ~ '..' : cat.name }}
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
</div>
{% else %}
  <p style="text-align:center; color:#fff;">No categories available.</p>
{% endif %}



<div class="diwali-second-title">
  ‚ú® Offers for You ‚ú®
</div>
{{recent_view}}
<!-- Related products (‡§Ü‡§§‡§æ hide ‡§ï‡§∞‡•Ç‡§® ‡§†‡•á‡§µ‡•Ç) -->
<div id="related-product-block" style="display:none;">
  {{ related_product }}
</div>

<div class="so-subcategory-wrapper">
  {% for chunk in subcategories1|batch(6) %}
    <div class="so-subcategory-cards">
        {% for subcat in chunk %}
            <div class="so-card-link" onclick="window.location.href='{{ subcat.href }}'">
                <div class="so-card">
                    <div class="so-card-image">
                        <img src="{{ subcat.thumb }}" alt="{{ subcat.name }}">
                    </div>
                    <div class="so-card-body">
                        <div class="first-heading">
                            {{ subcat.name|length > 15 ? subcat.name|slice(0, 12) ~ '..' : subcat.name }}
                        </div>
                        <div class="so-price">From ‚Çπ{{ subcat.price }}</div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
  {% endfor %}
</div>

    <div id="home-sections"></div>
    <div id="skeletons" class="cards-default-wrapper hidden" aria-hidden="true">
    {% for i in 1..6 %}
    <div class="custom-default skeleton skel-card">
      <div class="custom-default-image skeleton skel-thumb"></div>
      <div class="custom-default-title skeleton skel-line"></div>
      <div class="skeleton skel-line short"></div>
      <div class="skeleton skel-line tiny"></div>
    </div>
    {% endfor %}
  </div>

    <div id="loading" style="text-align:center; display:none;">Loading...</div>

{{related_category}}
<script>
  // --------------------------
  // State
  // --------------------------
  let page = 1;
  let loading = false;
  let endReached = false;

  // --------------------------
  // LoadMore Function
  // --------------------------
  function loadMore() {
    if (loading || endReached) return;
    loading = true;

    // Add skeleton loader before fetch
    const skeletonId = 'skeleton-section-' + page;
    const skeletonHtml = `
      <div class="skeleton-section" id="${skeletonId}">
        <div class="skeleton-heading"></div>
        <div class="subcategory-cards">
          <div class="cards-wrapper">
            <div class="cards-grid">
              ${Array(6).fill().map(() => `
                <div class="card-design-0 skeleton-card">
                  <div class="skeleton-image-large"></div>
                  <div class="skeleton-text"></div>
                  <div class="skeleton-price"></div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
    document.querySelector('#home-sections').insertAdjacentHTML('beforeend', skeletonHtml);

    fetch('index.php?route=common/home_content/loadMore&page=' + page)
      .then(res => res.json())
      .then(data => {
        console.log('response page=' + page, data);

        // Remove skeleton loader
        document.getElementById(skeletonId)?.remove();

        if (data.sections && data.sections.length > 0) {
          data.sections.forEach((section, index) => {

            // --------------------------
            // Section Shell
            // --------------------------
            let sectionHtml = `
              <div class="home-section" id="section-${page}-${index}">
                <div class="home-section-heading"> ‚ú®${section.title} ‚ú®</div>
                <div class="subcategory-cards">
            `;

            // --------------------------
            // Custom Designs
            // --------------------------

            /* 09-09-2025 added new _____________________________________________ */

            // PAGE 1, INDEX 0
            if (page === 1 && index === 0) {
              sectionHtml += `
                <div class="cards-wrapper">
                  <div class="cards-grid">
              `;
              section.items.forEach(item => {
                sectionHtml += `
                  <div class="card-design-0">
                    <div class="card-link" onclick="window.location.href='${item.href}'">
                      <div class="image-container">
                        <img class="index0-img" src="${item.thumb}" alt="${item.name}">
                        <div class="lighting-overlay"></div>
                      </div>
                      <div class="index0-heading">${item.name}</div>
                      <div class="index0-price">
                        From <span style="margin-left:5px;">
                          ${item.special && item.special !== '' ? item.special : item.price}
                        </span>
                        ${item.special && item.special !== '' ? `<span class="old-price">${item.price}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `;
              });
              sectionHtml += `
                  </div>
                </div>
              `;
            }

            // PAGE 1, INDEX 1 (Today's Best Deals) + ANCHOR after this section
            else if (page === 1 && index === 1) {
              sectionHtml += `
                <div class="deal-wrapper-1">
                  <div class="deal-scroll-container">
                    <div class="deal-grid-1">
              `;
              section.items.forEach(prod => {
                sectionHtml += `
                  <div class="deal-card-1" style="background:url('image/catalog/festival/0.1.jpeg') no-repeat center center; background-size:cover;">
                    <div class="deal-link-1" onclick="window.location.href='${prod.href}'">
                      <div class="deal-image-1">
                        <img src="${prod.thumb}" alt="${prod.name}">
                      </div>
                      <div class="deal-info-1">
                        <div class="deal-name-1">
                          ${prod.name.length > 15 ? prod.name.slice(0, 15) : prod.name}
                        </div>
                        <div class="deal-rating-1">
                          ${[1,2,3,4,5].map(i => i <= prod.rating ? '<span class="star-1">‚òÖ</span>' : '<span class="star-1 empty">‚òÖ</span>').join('')}
                        </div>
                        <div class="deal-price-1">
                          <span class="special-1">${prod.special}</span>
                          ${prod.price && prod.price !== prod.special ? `<span class="old-price-1">${prod.price}</span>` : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
              sectionHtml += `
                    </div>
                  </div>
                </div>
                <!-- üëá Anchor: ‡§Ø‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§≤‡§ó‡•á‡§ö ‡§ñ‡§æ‡§≤‡•Ä related products ‡§ü‡§æ‡§ï‡•Ç -->
                <div id="anchor-${page}-${index}"></div>
              `;
            }

            // PAGE 2, INDEX 0
            else if (page === 2 && index === 0) {
              sectionHtml += `<div class="best-deals-grid" style="background:url('image/catalog/festival/12.jpg') no-repeat center center; background-size:cover;">`;
              section.items.forEach(prod => {
                sectionHtml += `
                  <div class="best-deals-card" style="background:url('image/catalog/festival/1.png') no-repeat center center; background-size:cover;">
                    <div class="best-deals-link" onclick="window.location.href='${prod.href}'">
                      <div class="best-deals-image">
                        <img src="${prod.thumb}" alt="${prod.name}">
                      </div>
                      <div class="best-deals-info">
                        <div class="best-deals-name">${prod.name.length > 12 ? prod.name.slice(0, 12) + '...' : prod.name}</div>
                        <div class="best-deals-price">
                          ‚Çπ${prod.special && prod.special !== '' ? prod.special : prod.price}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
              sectionHtml += `</div>`;
            }

            // PAGE 2, INDEX 1
            else if (page === 2 && index === 1) {
              sectionHtml += `
                <div class="card-layout">
                  ${section.items.map(item => `
                    <div class="card-l"
                      style="background:url('image/catalog/festival/F4.png') no-repeat center center; background-size:cover;"
                      onclick="window.location.href='${item.href}'">

                      <div class="card-img-l">
                        <img src="${item.thumb}" alt="${item.name}">
                      </div>

                      <div class="card-title-l">
                        ${item.name.length > 18 ? item.name.slice(0, 15) + '...' : item.name}
                      </div>

                      <div class="card-rating-l">
                        ${[1,2,3,4,5].map(i =>
                          i <= item.rating ? '<span class="star">‚òÖ</span>' : '<span class="star empty">‚òÖ</span>'
                        ).join('')}
                      </div>

                      <div class="card-price-l">
                        <span class="current-price-l">
                          ${item.special && item.special !== '' ? item.special : item.price}
                        </span>
                        ${item.special && item.special !== '' ? `<span class="old-price-l">${item.price}</span>` : ''}
                      </div>

                    </div>
                  `).join('')}
                </div>
              `;
            }

            // PAGE 3, INDEX 0
            else if (page === 3 && index === 0) {
              sectionHtml += `<div class="recent-grid" style="background:url('image/catalog/festival/14454-Photoroom.png') no-repeat center center; background-size:cover;">`;
              section.items.forEach(prod => {
                sectionHtml += `
                  <div class="recent-card">
                    <div class="recent-link" onclick="window.location.href='${prod.href}'">
                      <div class="recent-image">
                        <img src="${prod.thumb}" alt="${prod.name}">
                        <div class="recent-label">${prod.name}</div>
                      </div>
                      <div class="recent-info">
                        <div class="recent-name">
                          ${prod.name.length > 17 ? prod.name.slice(0, 17) + '...' : prod.name}
                        </div>
                        <div class="recent-price" style="color:#953A93; font-weight:600;">
                          From <span style="color:#953A93;">
                            ${prod.special && prod.special !== '' ? prod.special : prod.price}
                          </span>
                          ${prod.special && prod.special !== '' ? `
                            <span class="old-price" style="color:#888; text-decoration:line-through; margin-left:5px;">
                              ${prod.price}
                            </span>` : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
              sectionHtml += `</div>`;
            }

            // DEFAULT
            else {
              sectionHtml += `<div class="cards-default-wrapper">`;
              section.items.forEach(prod => {
                const mrp = Number(String(prod.price || '').replace(/[^\d.]/g, ''));
                const sp  = Number(String(prod.special || '').replace(/[^\d.]/g, ''));
                const hasDisc = sp && mrp && sp < mrp;
                const offPct = hasDisc ? Math.round(((mrp - sp) / mrp) * 100) : 0;

                sectionHtml += `
                  <div class="custom-default">
                    <div class="custom-default-link" onclick="window.location.href='${prod.href}'">
                      <div class="custom-default-image">
                        <img src="${prod.thumb}" alt="${prod.name}">
                      </div>
                      <div class="custom-default-title">
                        ${prod.name.length > 18 ? prod.name.slice(0, 15) + '...' : prod.name}
                      </div>
                      <div class="custom-default-price">
                        <span class="sale">${prod.special && prod.special !== '' ? prod.special : prod.price}</span>
                        ${prod.special && prod.special !== '' ? `<span class="old-price">${prod.price}</span>` : ''}
                      </div>
                      ${hasDisc ? `<div class="custom-default-discount">${offPct}% OFF</div>` : ''}
                    </div>
                  </div>
                `;
              });
              sectionHtml += `</div>`;
            }

            // --------------------------
            // Close Section Shell
            // --------------------------
            sectionHtml += `
                </div>
              </div>
            `;

            // --------------------------
            // Insert Logic
            // --------------------------
            const homeSections = document.getElementById('home-sections');

            if (page === 1 && index === 0) {
              console.log("Insert Logic ‚Üí page=1, index=0");
              homeSections.insertAdjacentHTML('beforeend', sectionHtml);
            }
            else if (page === 1 && index === 1) {
              console.log("Insert Logic ‚Üí page=1, index=1");
              homeSections.insertAdjacentHTML('beforeend', sectionHtml);

              // ‚úÖ Deals ‡§®‡§Ç‡§§‡§∞ related products insert ‡§ï‡§∞‡§æ (‡§´‡§ï‡•ç‡§§ ‡§è‡§ï‡§¶‡§æ‡§ö)
              if (!window.__relatedInjected) {
                const anchorEl = document.getElementById(`anchor-${page}-${index}`) || document.getElementById(`section-${page}-${index}`);
                const relBlock = document.getElementById('related-product-block');
                if (anchorEl && relBlock) {
                  anchorEl.insertAdjacentElement('afterend', relBlock);
                  relBlock.style.display = 'block';
                  window.__relatedInjected = true;
                }
              }
            }
            else if (page === 2 && index === 0) {
              console.log("Insert Logic ‚Üí page=2, index=0");
              homeSections.insertAdjacentHTML('beforeend', sectionHtml);
            }
            else {
              console.log(`Insert Logic ‚Üí default (page=${page}, index=${index})`);
              homeSections.insertAdjacentHTML('beforeend', sectionHtml);
            }

          });

          page++;
        } else {
          console.log("No more sections for page=" + page);
          endReached = true;
        }

        loading = false;

        // If content still shorter than viewport, try to load next page
        if (document.body.offsetHeight <= window.innerHeight) {
          loadMore();
        }
      })
      .catch(err => {
        console.error(err);
        loading = false;
      });
  }

  // --------------------------
  // Initial load
  // --------------------------
  loadMore();

  // --------------------------
  // Infinite Scroll Event
  // --------------------------
  window.addEventListener('scroll', () => {
    // console.log("scroll check", window.innerHeight + window.scrollY, document.body.offsetHeight);
    if (!loading && window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
      loadMore();
    }
  });
</script>

<!-- Add this before the closing </body> tag -->
<div id="sentinel"></div></div>

