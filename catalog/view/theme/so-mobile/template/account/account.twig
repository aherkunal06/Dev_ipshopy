<link rel="stylesheet" href="catalog/view/theme/so-mobile/css/customer/account.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

{{ header }}

<div id="account-account" class="">
  {% if success %}
    <div class="alert alert-success alert-dismissible">
      <i class="fa fa-check-circle"></i>
      {{ success }}
    </div>
  {% endif %}

  <div class='account_wrapper'>
    <div class="" id="account-info-container">
      {{ column_left_account }}
      
      <div id="content" class="{{ class }} right_section">
        
        <!-- Breadcrumb -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
          <tr>
            <td style="text-align: left; border: none;">
              <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                  <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
              </ul>
            </td>
          </tr>
        </table>

        {{ content_top }}

        <form action="{{ action }}" method="post" enctype="multipart/form-data">
          
          <div class="Account-information container py-4 position-relative">
            
            <!-- Profile Section - Centered -->
            <div style="text-align: center; margin-bottom: 0px;">
              <!-- Profile Photo -->
              <div class="profile-photo-wrapper position-relative" style="display: inline-block; margin-bottom: 15px;">
                <div style="width: 120px; height: 120px; border-radius: 50%; background: #ffffff; display: flex; justify-content: center; align-items: center; margin: 0 auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
                  {% if profile_photo_url %}
                    <img src="{{ profile_photo_url }}" id="profile-image" style="width: 120px; height: 120px; object-fit: cover; border-radius: 50%;" class="rounded-circle">
                  {% else %}
                    <i class="fa-solid fa-user" style='font-size:50px; color:#d1d5db;'></i>
                  {% endif %}
                </div>
                <label class="input-profile-photo position-absolute" style="display:none; cursor:pointer; bottom: 0; right: 0; width: 36px; height: 36px; background: #953a93; border-radius: 50%; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 10px rgba(149, 58, 147, 0.3); position: absolute;">
                  <i class="fa-solid fa-pen" style="color: white; font-size: 16px;"></i>
                </label>
                <input type="file" name="profile_photo" id="input-profile-photo" accept="image/*" style="display: none;">
              </div>
              
              
              <!-- Profile Info -->
              <div style="text-align: center;">
                <h2 style="font-size: 24px; font-weight: 600; color: #111827; margin: 0 0 8px 0; letter-spacing: -0.5px;">{{ firstname }} {{ lastname }}</h2>
                <p style="font-size: 15px; color: #6b7280; margin: 0; font-weight: 400;">{{ email }}</p>
              </div>
            </div>

            <!-- Account Information Header -->
            <table style="width: 100%; margin-bottom: 32px;">
              <tr>
                <td style="text-align: left; vertical-align: middle;">
                  <h1 style="color: #111827; font-size: 22px; font-weight: 600; margin: 0; letter-spacing: -0.3px;">Account Information</h1>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                  <div id="edit-toggle" class="edit-button d-inline-flex align-items-center justify-content-center" data-state="view" style="background: none; border: none; color: #953a93; font-size: 16px; font-weight: 500; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: all 0.2s ease;">
                    <i class="fa-solid fa-pen edit-icon me-2"></i>
                    <span class="edit-text">Edit</span>
                  </div>
                </td>
              </tr>
            </table>

            <!-- Form Fields -->
            <div class="account-section">
              <div class="row">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 0pxpx;">
                  <div class="mb-3">
                    <label for="input-firstname" style="font-size: 14px; font-weight: 500; color: #6b7280; margin-bottom: 8px; display: block;">First Name</label>
                    <input type="text" name="firstname" value="{{ firstname }}" placeholder="{{ entry_firstname }}" id="input-firstname" class="form-control editable-field" readonly />
                    {% if error_firstname %}<div class="text-danger">{{ error_firstname }}</div>{% endif %}
                  </div>
                  <div class="mb-3">
                    <label for="input-lastname" style="font-size: 14px; font-weight: 500; color: #6b7280; margin-bottom: 8px; display: block;">Last Name</label>
                    <input type="text" name="lastname" value="{{ lastname }}" placeholder="{{ entry_lastname }}" id="input-lastname" class="form-control editable-field" readonly />
                    {% if error_lastname %}<div class="text-danger">{{ error_lastname }}</div>{% endif %}
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                  <div class="mb-3">
                    <label for="input-email" style="font-size: 14px; font-weight: 500; color: #6b7280; margin-bottom: 8px; display: block;">Email Address</label>
                    <input type="email" name="email" value="{{ email }}" placeholder="{{ entry_email }}" id="input-email" class="form-control editable-field" readonly />
                    {% if error_email %}<div class="text-danger">{{ error_email }}</div>{% endif %}
                  </div>
                  <div class="mb-3">
                    <label for="input-telephone" style="font-size: 14px; font-weight: 500; color: #6b7280; margin-bottom: 8px; display: block;">Mobile No</label>
                    <input type="tel" name="telephone" value="{{ telephone }}" placeholder="Mobile No" id="input-telephone" class="form-control editable-field" readonly  />
                    {% if error_telephone %}<div class="text-danger">{{ error_telephone }}</div>{% endif %}
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex justify-content-end gap-2 mt-3" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 0px; padding-top: 0px; border-top: 1px solid #f3f4f6;">
                <button class="btn btn-primary" type="submit" id="continue-button" style="display: none; background: linear-gradient(135deg, #953a93 0%, #7c2d7c 100%); color: white; border: none; padding: 8px 18px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(149, 58, 147, 0.3);" disabled>Save Changes</button>
                {#<button type="button" id="cancel-button" style="display: none; background: white; color: #6b7280; border: 1.5px solid #d1d5db; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">Cancel</button>#}
              </div>
            </div>
          </div>

          <!-- Custom Fields Section -->
          {% for custom_field in custom_fields %}
            {% if custom_field.type == 'select' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label" for="input-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <select name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" id="input-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                    <option value="">{{ text_select }}</option>
                    {% for custom_field_value in custom_field.custom_field_value %}
                      {% if account_custom_field[custom_field.custom_field_id] and custom_field_value.custom_field_value_id == account_custom_field[custom_field.custom_field_id] %}
                        <option value="{{ custom_field_value.custom_field_value_id }}" selected="selected">{{ custom_field_value.name }}</option>
                      {% else %}
                        <option value="{{ custom_field_value.custom_field_value_id }}">{{ custom_field_value.name }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'radio' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <div>
                    {% for custom_field_value in custom_field.custom_field_value %}
                      <div class="radio">
                        {% if account_custom_field[custom_field.custom_field_id] and custom_field_value.custom_field_value_id == account_custom_field[custom_field.custom_field_id] %}
                          <label>
                            <input type="radio" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{{ custom_field_value.custom_field_value_id }}" checked="checked"/>
                            {{ custom_field_value.name }}
                          </label>
                        {% else %}
                          <label>
                            <input type="radio" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{{ custom_field_value.custom_field_value_id }}"/>
                            {{ custom_field_value.name }}
                          </label>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'checkbox' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <div>
                    {% for custom_field_value in custom_field.custom_field_value %}
                      <div class="checkbox">
                        {% if account_custom_field[custom_field.custom_field_id] and custom_field_value.custom_field_value_id in account_custom_field[custom_field.custom_field_id] %}
                          <label>
                            <input type="checkbox" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}][]" value="{{ custom_field_value.custom_field_value_id }}" checked="checked"/>
                            {{ custom_field_value.name }}
                          </label>
                        {% else %}
                          <label>
                            <input type="checkbox" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}][]" value="{{ custom_field_value.custom_field_value_id }}"/>
                            {{ custom_field_value.name }}
                          </label>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'text' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label" for="input-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <input type="text" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{% if account_custom_field[custom_field.custom_field_id] %}{{ account_custom_field[custom_field.custom_field_id] }}{% else %}{{ custom_field.value }}{% endif %}" placeholder="{{ custom_field.name }}" id="input-custom-field{{ custom_field.custom_field_id }}" class="form-control"/>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'textarea' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label" for="input-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <textarea name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" rows="5" placeholder="{{ custom_field.name }}" id="input-custom-field{{ custom_field.custom_field_id }}" class="form-control">{% if account_custom_field[custom_field.custom_field_id] %}{{ account_custom_field[custom_field.custom_field_id] }}{% else %}{{ custom_field.value }}{% endif %}</textarea>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'file' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <button type="button" id="button-custom-field{{ custom_field.custom_field_id }}" data-loading-text="{{ text_loading }}" class="btn btn-default">
                    <i class="fa fa-upload"></i>
                    {{ button_upload }}
                  </button>
                  <input type="hidden" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{% if account_custom_field[custom_field.custom_field_id] %}{{ account_custom_field[custom_field.custom_field_id] }} {% endif %}"/>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'date' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label" for="input-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <div class="input-group date">
                    <input type="text" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{% if account_custom_field[custom_field.custom_field_id] %}{{ account_custom_field[custom_field.custom_field_id] }}{% else %}{{ custom_field.value }}{% endif %}" placeholder="{{ custom_field.name }}" data-date-format="YYYY-MM-DD" id="input-custom-field{{ custom_field.custom_field_id }}" class="form-control"/>
                    <span class="input-group-btn">
                      <button type="button" class="btn btn-default">
                        <i class="fa fa-calendar"></i>
                      </button>
                    </span>
                  </div>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'time' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label" for="input-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <div class="input-group time">
                    <input type="text" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{% if account_custom_field[custom_field.custom_field_id] %}{{ account_custom_field[custom_field.custom_field_id] }}{% else %}{{ custom_field.value }}{% endif %}" placeholder="{{ custom_field.name }}" data-date-format="HH:mm" id="input-custom-field{{ custom_field.custom_field_id }}" class="form-control"/>
                    <span class="input-group-btn">
                      <button type="button" class="btn btn-default">
                        <i class="fa fa-calendar"></i>
                      </button>
                    </span>
                  </div>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if custom_field.type == 'datetime' %}
              <div class="form-group{% if custom_field.required %} required {% endif %} custom-field" data-sort="{{ custom_field.sort_order }}">
                <label class="col-sm-2 control-label" for="input-custom-field{{ custom_field.custom_field_id }}">{{ custom_field.name }}</label>
                <div class="col-sm-10">
                  <div class="input-group datetime">
                    <input type="text" name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" value="{% if account_custom_field[custom_field.custom_field_id] %}{{ account_custom_field[custom_field.custom_field_id] }}{% else %}{{ custom_field.value }}{% endif %}" placeholder="{{ custom_field.name }}" data-date-format="YYYY-MM-DD HH:mm" id="input-custom-field{{ custom_field.custom_field_id }}" class="form-control"/>
                    <span class="input-group-btn">
                      <button type="button" class="btn btn-default">
                        <i class="fa fa-calendar"></i>
                      </button>
                    </span>
                  </div>
                  {% if error_custom_field[custom_field.custom_field_id] %}
                    <div class="text-danger">{{ error_custom_field[custom_field.custom_field_id] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}

        </form>

        {{ content_bottom }}
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const editToggle = document.getElementById('edit-toggle');
  const imageEditLabel = document.querySelector('.input-profile-photo');
  const imageInput = document.getElementById('input-profile-photo');
  const profileImage = document.getElementById('profile-image');
  const continueBtn = document.getElementById('continue-button');
  const editableFields = document.querySelectorAll('.editable-field');
  const firstNameInput = document.getElementById('input-firstname');
  const lastNameInput = document.getElementById('input-lastname');
  const emailInput = document.getElementById('input-email');
  const phoneInput = document.getElementById('input-telephone');
  const originalValues = {};

  // Save original values
  editableFields.forEach(field => {
    originalValues[field.id] = field.value;
    field.setAttribute('readonly', true);
    field.classList.remove('editing');
  });

  // ========== Trim + block inner and edge spaces for names ==========
  function cleanAndRestrictNameInput(input) {
    input.addEventListener('input', () => {
      input.value = input.value.replace(/\s+/g, ''); // Remove all spaces
    });
    input.addEventListener('blur', () => {
      input.value = input.value.trim();
    });
  }
  cleanAndRestrictNameInput(firstNameInput);
  cleanAndRestrictNameInput(lastNameInput);

  // ========== Email Trim ==========
  emailInput.addEventListener('blur', () => {
    emailInput.value = emailInput.value.trim();
  });

  // ========== Phone Validation ==========
  phoneInput.addEventListener("input", function () {
    this.value = this.value.replace(/[^0-9]/g, "").replace(/^0+/, "").slice(0, 10);
  });

  // ========== Field Validation ==========
  function validateField(input, isValid, message) {
    if (!isValid) {
      input.classList.add('is-invalid');
      let error = input.nextElementSibling;
      if (!error || !error.classList.contains('text-danger')) {
        error = document.createElement('div');
        error.className = 'text-danger';
        input.parentNode.appendChild(error);
      }
      error.textContent = message;
    } else {
      input.classList.remove('is-invalid');
      let error = input.nextElementSibling;
      if (error && error.classList.contains('text-danger')) {
        error.remove();
      }
    }
  }

  function validateForm() {
    if (firstNameInput.hasAttribute('readonly')) return;
    const firstName = firstNameInput.value.trim();
    const lastName = lastNameInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    let valid = true;

    if (!firstName || firstName.length < 3 || firstName.length > 15) {
      validateField(firstNameInput, false, 'First name must be 3–15 characters and not empty');
      valid = false;
    } else {
      validateField(firstNameInput, true);
    }

    if (!lastName || lastName.length < 3 || lastName.length > 15) {
      validateField(lastNameInput, false, 'Last name must be 3–15 characters and not empty');
      valid = false;
    } else {
      validateField(lastNameInput, true);
    }

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email || !emailPattern.test(email)) {
      validateField(emailInput, false, 'Enter a valid email address');
      valid = false;
    } else {
      validateField(emailInput, true);
    }

    const phonePattern = /^[6-9][0-9]{9}$/;
    if (!phone || !phonePattern.test(phone)) {
      validateField(phoneInput, false, 'Enter a valid 10-digit mobile starting with 6-9');
      valid = false;
    } else {
      validateField(phoneInput, true);
    }

    continueBtn.disabled = !valid;
  }

  // ========== Edit Toggle ==========
  if (editToggle) {
    editToggle.addEventListener('click', function () {
      const state = editToggle.getAttribute('data-state');
      if (state === 'view') {
        editableFields.forEach(field => {
          field.removeAttribute('readonly');
          field.classList.add('editing');
          field.style.borderColor = '#953a93';
          field.style.backgroundColor = '#ffffff';
        });
        editToggle.setAttribute('data-state', 'edit');
        editToggle.querySelector('.edit-text').textContent = 'Cancel';
        editToggle.querySelector('.edit-icon').classList.remove('fa-pen');
        editToggle.querySelector('.edit-icon').classList.add('fa-times');
        continueBtn.style.display = 'inline-block';
        validateForm();
      } else {
        editableFields.forEach(field => {
          field.setAttribute('readonly', true);
          field.classList.remove('editing');
          field.value = originalValues[field.id];
          field.style.borderColor = '#000000';
          field.style.backgroundColor = '#ffffff';
          validateField(field, true);
        });
        editToggle.setAttribute('data-state', 'view');
        editToggle.querySelector('.edit-text').textContent = 'Edit';
        editToggle.querySelector('.edit-icon').classList.remove('fa-times');
        editToggle.querySelector('.edit-icon').classList.add('fa-pen');
        continueBtn.style.display = 'none';
        continueBtn.disabled = true;

        const originalImage = "{{ profile_photo_url }}";
        if (originalImage && profileImage) profileImage.src = originalImage;
        imageInput.value = '';
      }
    });
  }

  // ========== Profile Image ==========
  let imageClickLocked = false;
  if (imageEditLabel) {
    imageEditLabel.addEventListener('click', function (e) {
      if (imageClickLocked || editToggle.getAttribute('data-state') !== 'edit') {
        e.preventDefault();
        return;
      }
      imageClickLocked = true;
      imageInput.value = '';
      imageInput.click();
      setTimeout(() => imageClickLocked = false, 500);
    });
  }

  if (imageInput) {
    imageInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          if (profileImage) {
            profileImage.src = e.target.result;
          } else {
            const placeholder = document.querySelector('.fa-user');
            if (placeholder && placeholder.parentNode) {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.id = 'profile-image';
              img.style = 'width: 120px; height: 120px; object-fit: cover; border-radius: 50%;';
              img.className = 'rounded-circle';
              placeholder.parentNode.innerHTML = '';
              placeholder.parentNode.appendChild(img);
            }
          }
          continueBtn.style.display = 'inline-block';
          continueBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      } else if (file) {
        alert("Please select a valid image file.");
      }
    });
  }

  // ========== Validate on typing ==========
  [firstNameInput, lastNameInput, emailInput, phoneInput].forEach(input => {
    if (input) {
      input.addEventListener('input', validateForm);
    }
  });

  // ========== Show/Hide Image Edit ==========
  if (editToggle && imageEditLabel) {
    editToggle.addEventListener('click', function () {
      setTimeout(() => {
        const currentState = editToggle.getAttribute('data-state');
        imageEditLabel.style.display = currentState === 'edit' ? 'flex' : 'none';
      }, 10);
    });
  }
});
</script>

{{ footer }}