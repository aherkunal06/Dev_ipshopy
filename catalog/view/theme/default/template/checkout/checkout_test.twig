<link href="httpss://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
 {#<script src="catalog/view/theme/so-revo/js/visualsearch.js"></script>#}
{#<link rel="stylesheet" href="catalog/view/theme/so-revo/css/visual001.css">#}
{{ header }}
<style>
	/* Ensure panels are responsive and aligned */
	.panel {
		margin-bottom: 20px;
	}
	.panel-heading {
		border-top: 1px solid transparent;
		border-right: 1px solid transparent;
	}

	.panel-group .panel {
		margin-bottom: 20px;
		border-radius: 4px;
	}
	/* Ensure input fields are full-width on small screens */
	@media(max-width: 768px) {
		.form-group input,
		.form-group select {}
		.table {
			display: block;
			overflow-x: auto;
		}
		.table th,
		.table td {
			width: 50px !important;
			white-space: nowrap;
		}
		.panel-body {
			padding: 10px;
		}
		.panel-title {
			font-size: 16px;
		}
	}

	/* Adjust margins and paddings for smaller screens */
	@media(max-width: 576px) {
		.container {
			padding: 10px;
		}
		.panel-heading {
			padding: 10px;
		}
		.panel-title {
			font-size: 14px;
		}
		.form-group label {
			font-size: 14px;
		}
		.form-group input,
		.form-group select {
			font-size: 14px;
			padding: 8px;
		}
	}

	.input-with-button {
		position: relative;
	}

	.input-with-button input {
		padding-right: 40px;
	}

	.input-with-button button {
		position: absolute;
		top: 50%;
		right: 10px;
		transform: translateY(-50%);
		padding: 5px 10px;
		border: none;
		background: none;
		color: #555;
		font-size: 18px;
		cursor: pointer;
	}

	.input-with-button button:hover {
		color: #000;
	}

	/* Remove panel background, shadow, and padding */
	.panel-default {
		background: none;
		box-shadow: none;
		border: none;
		padding: 0;
	}

	/* Section title */
	.panel-heading h4 {
		font-size: 24px;
		font-weight: 600;
		margin-bottom: 25px;
	}

	/* Form labels */
	.form-group label {
		font-size: 16px;
		font-weight: 500;
		margin-bottom: 8px;
	}

	/* Inputs and selects */
	.form-control {
		border-radius: 6px;
		padding: 12px;
		font-size: 15px;
		border: 1px solid #ddd;
		background-color: #f9f9f9;
		box-shadow: none;
	}

	.form-control:focus {
		border-color: #6f42c1;
		background-color: #fff;
		box-shadow: none;
	}

	.form-control::placeholder {
		color: #aaa;
	}

	/* Radio options */
	.radio label {
		display: block;
		font-size: 14px;
		font-weight: 600;
		margin-bottom: 10px;
	}

	/* Submit button (purple theme) */
	#save_payment_address {
		/* margin-top: 20px; */
		background-color: #953A93; /* purple */
		color: #fff;
		font-weight: 500;
		border-radius: 8px;
		border: none;
		padding: 12px 24px;
		transition: 0.3s ease;
		/* margin-inline-start: auto; */
	}

	#save_payment_address:hover {
		background-color: #953A93; /* darker purple on hover */

	}


	#save_shipping_address {
		/* margin-top: 20px; */
		background-color: #953A93; /* purple */
		color: #fff;
		font-weight: 500;
		border-radius: 8px;
		border: none;
		padding: 12px 24px;
		transition: 0.3s ease;
		/* margin-inline-start: auto; */
	}
	#save_shipping_address:hover {
		background-color: #953A93; /* darker purple on hover */
	}
	.table-responsive {
		min-height: .01%;
		overflow-x: hidden;
	}
	.control-quantity {
		width: 40px !important;
		height: 30px;
		text-align: center !important;
		font-size: 14px !important;
		padding: 0 !important;
		display: flex;
		justify-content: center;
		align-items: center;
		color: black;
	}
	.quantity_button {
		display: flex;
		justify-content: center;
		align-items: center;
		border: none;
		background: gray;
		font-size: 18px;
		color: white;
		width: 30px;
		height: 30px;
	}
	.btn-cust {
		background-color: #953A93;
		/* width: 25%; */
		color: white;
		/* padding: 10px; */
		display: inline-block;
		border-radius: 5px;
		line-height: 20px;
		padding: 6px 15px !important;
		width: fit-content;
		cursor: pointer;
	}
	.hidden_input {
		width: 0 !important;
		padding: 0;
		margin: 0;
		border: none;
		visibility: none;
	}
	.address_cancel {
		cursor: pointer;
		margin: 0;
		font-size: 16px;
		color: black;
	}
	.address_button_container {
		display: flex;
		justify-content: end;
		align-items: center;
		gap: 15px;

	}
	.address_button_container button {
		margin: 0;
	}
	.address_rigght {
		min-width: max-content;
		margin: 0;
		align-self: end;
	}
	.address_rigght label {
		margin: 0
	}
	.address_left {
		width: 100%;
	}
	.address_left select {
		padding-block: 8px !important;
    font-size: 13px;
    width: 100%;
	}
	.address_left strong {
		color: black;
		font-size: 16px;
	}
	.address_existing_container {
		display: flex;
		gap: 15px;

	}
	.address_existing_container .form-group {
		margin: 0;
	}
	/*#input-payment-address-2, #input-payment-address-1,#input-shipping-address2,#input-shipping-address {*/
	/*    width:100%;*/
	/*}*/
	#new-shipping-address-form input,#new-shipping-address-form select{
	    width:100%;
	}
	.address_title {
		line-height: 20px;
	}
	.new_address_form {
		margin-top: 15px;
		box-shadow: 0 0 5px #9a9a9a;
		padding: 20px;
	}
	.new_address_form label {
		line-height: 20px;
		font-size: 14px;
		margin-bottom: 2px;
	}
	.new_address_form .form-group {
		margin-bottom: 10px;
	}
	.address_card {
		box-shadow: 0 0 3px #d0cfd1;
		/* padding-top: 0; */
	}
	.price_section {
		/* width: 320px; */
		width: 100%;
		box-shadow: 0 0 3px #9a9a9a;
		padding: 20px;
	}
	.price_section .price_heading {
		margin-inline: -20px;
		border-bottom: 1px solid #eee;
		color: #7d7d7d;
		text-align: left;
		margin-bottom: 15px;
		padding-bottom: 10px;
		padding-left: 20px;
		font-weight: 600;
		font-size: 16px;
	}
	.price_section .price_bottom {
		margin-top: 15px;
		padding-top: 10px;
		border-top: 1px solid #eee;
		color: #7d7d7d;
		font-weight: 600;
	}
	.price_section .price_bottom .price_rows {
		margin-bottom: 0;

	}
	.price_section {
		margin-bottom: 20px;
	}
	.price_section .price_rows {
		display: flex;
		justify-content: space-between;
		font-size: 16px;
		color: black;
		margin-bottom: 20px;
	}
	.price_section h5 {
		font-weight: 500;

	}
	.cart_heading {
		padding: 10px 15px;
		background: #953A93;
		color: white;
	}
	.coupon_button {
		padding-block: 6px;
		background: #953A93;
		width: 150px;
		border: 1px solid #953A93;
		border-top-right-radius: 5px;
		border-bottom-right-radius: 5px;
	}
	.coupon_button:hover {
		background: white;
		color: #953A93;
		border: 1px solid #953A93;

	}
	.coupon_section {
		padding: 0;
	}
	.coupon_section .form-control {
		height: auto;
		padding-block: 6px;
		    font-size: 14px;
    line-height: 24px;
    border: none;
    border-radius: 0px !important;
    border-top-left-radius: 5px !important;
    border-bottom-left-radius: 5px !important;
	}
	.payment_option_label {
		display: flex;
		align-items: center;
		gap: 10px;
	}
	.payment_option_label input {
		width: fit-content !important;
	}
	.payment_method_custom .radio,
	.payment_method_custom .checkbox {
		margin: 0;
	}
	.payment_method_custom .payment_option_label {
		display: flex !important;
		margin-block: 5px !important;
		color: black;
         font-weight: 500;
	}
	.payment_method_custom .payment_option_label b{
	    color:black;
	}
	.payment_heading {
		background-color: white !important;
		border-top: none;
		border-right: none;
		font-weight: 600;
		/* padding: 0; */
		border-bottom: 1px solid #eee !important;
		margin-inline: -15px;
	}
	.payment_heading h4 {
		color: #7d7d7d;
		margin: 0;
		padding: 0;
		background: transparent;
		font-size: 16px;
	}
	.payment_method_container {
		padding: 15px;

		box-shadow: 0 0 5px #9a9a9a;
	}
	table th {
		text-align: left;
	}
    .payment_method_custom textarea{
        width:100%;
    }	
    .payment_method_custom .payment_option_label input{
            margin-bottom: 5px;
    }
    .new-shipping-address-form input,.new-shipping-address-form select, .new_address_form input,.new_address_form select {
    width: 100% !important;
}
table tbody tr td{
    vertical-align: middle !important;
    
}
</style>

{% if not logged %}
	{{login}}
{% else %}

	<div
		class="container" id="checkout-checkout" style="margin-top: 20px;">
		 {#<ul class="breadcrumb">#}
		{#{% for breadcrumb in breadcrumbs %}#}
		{#<li>#}
		{#<a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a>#}
		{#</li>#}
		{#{% endfor %}#}
		{#</ul> #}

		{% if error_warning %}
			<div class="alert alert-danger alert-dismissible">
				<i class="fa fa-exclamation-circle"></i>
				{{ error_warning }}
				<button id="confirm-order" type="button" class="close" data-dismiss="alert">&times;</button>
			</div>
		{% endif %}

		{# <h2>{{ heading_title }}</h2> #}
		<div class="panel-group" id="accordion">
			<div class="row">
				<div
					class='col-sm-8'>
					{# payment address starts  #}
					<div class="">
						<form action='{{payment_address_action}}' method="post" id="payment-form">

							<div
								class="panel panel-default">
								 {#<div class="panel-heading">#}
								{#<strong class="panel-title">{{ text_checkout_payment_address }}</strong>#}
								{#</div> #}

								<div id="collapse-payment-address">
									<div
										class="panel-body address_card">

										<!-- Radio option for Existing (Cancel) -->
										<div class="radio d-none">
											<label>
												<input type="radio" name="payment_address" id="billingAddressExisting" value="existing" checked>
												Cancel
											</label>
										</div>
										<div class="address_existing_container">
											<div class="address_left">
												<div class='address_title'>
													<strong class="panel-title">{{ text_checkout_payment_address }}</strong>
												</div>
												<!-- Existing Address Section -->
												<div id="existing-address">
													{% if addresses %}
														<div class="form-group mt-2">
															<select id="existing_address_id" name="address_id" class="">
																{% for address in addresses %}
																	<option value="{{ address.address_id }}" {% if address.address_id == selected_address_id %} selected {% endif %}>
																		{{ address.firstname }}
																		{{ address.lastname }},
																		{{ address.address_1 }},
																		{{ address.city }},
																		{{ address.postcode }}
																	</option>
																{% endfor %}
															</select>
														</div>
													{% else %}
														<p class="text-danger">{{ text_no_existing_address }}</p>
													{% endif %}
												</div>
											</div>
											<!-- Button-style radio for Add New Address -->
											<div class="radio address_rigght">
												<label class="btn-cust" style="color:white; cursor:pointer;" id='new_payment_address_button'>
													<input type="radio" name="payment_address" id="billingAddressNew" value="new" class="hidden_input">
													Add Address
												</label>
											</div>
										</div>
										<!-- New Address Form -->
										<div id="new-address" class='new_address_form' style="display: none;">
											<div class="row">
												<div class="col-md-4">
													<div class="form-group">
														<label for="input-firstname">{{ entry_firstname }}</label>
														<input type="text" name="firstname" id="input-firstname" class="form-control" value="{{ firstname }}" placeholder="{{ entry_firstname }}">
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="input-lastname">{{ entry_lastname }}</label>
														<input type="text" name="lastname" id="input-lastname" class="form-control" value="{{ lastname }}" placeholder="{{ entry_lastname }}">
													</div>
												</div>
												<div class='col-md-4'>
        												<div class="form-group">
        													<label for="input-telephone">{{ entry_telephone }}</label>
        													<input type="text" name="entry_telephone" id="input-telephone" class="form-control" placeholder="{{ entry_telephone }}">
        												</div>
												</div>
											</div>

											<!-- Address Lines -->
											<div class="form-group">
												<label for="input-payment-address-1">{{ entry_address_1 }}</label>
												<input type="text" name="address_1" id="input-payment-address-1" class="form-control" value="{{ address_1 }}" placeholder="{{ entry_address_1 }}">
											</div>
											<div class="form-group">
												<label for="input-payment-address-2">{{ entry_address_2 }}</label>
												<input type="text" name="address_2" id="input-payment-address-2" class="form-control" value="{{ address_2 }}" placeholder="{{ entry_address_2 }}">
											</div>

											<!-- City & Postcode -->
											<div class="row">
											    <div class="col-md-6">
													<div class="form-group">
														<label for="input-country">{{ entry_country }}</label>
														<select name="country_id" id="input-country" class="form-control">
															{% for country in countries %}
																{% if country.country_id == 99 %}
																	<option value="{{ country.country_id }}" selected="selected">{{ country.name }}</option>
																{% else %}
																	<option value="{{ country.country_id }}">{{ country.name }}</option>
																{% endif %}
															{% endfor %}
														</select>
													</div>
												</div>
												
												<div class="col-md-6">
													<div class="form-group">
														<label for="input-postcode">{{ entry_postcode }}</label>
														<input type="text" name="postcode" id="input-postcode" class="form-control" value="{{ postcode }}" placeholder="{{ entry_postcode }}">
													</div>
												</div>
											</div>

											<!-- Country & Zone -->
											<div class="row">
												<div class="col-md-6">
													<div class="form-group">
														<label for="input-city">{{ entry_city }}</label>
														<input type="text" name="city" id="input-city" class="form-control" value="{{ city }}" placeholder="{{ entry_city }}">
													</div>
												</div>
												<div class="col-md-6">
													<div class="form-group">
														<label for="input-zone">{{ entry_zone }}</label>
														<div class="">
															<!-- Visible field for State Name -->
															<input
															type="text" placeholder="{{ entry_zone }}" id="input-payment-zone_name" class="form-control" readonly/>

															<!-- Hidden input for Zone ID (important for database) -->
															<input type="hidden" name="zone_id" id="input-payment-zone"/>
														</div>
													</div>
												</div>
											</div>

											<!-- Buttons -->
											<div class="text-end mt-3 address_button_container">
												<label for="billingAddressExisting" class="address_cancel" style="margin-right: 10px; cursor:pointer;">Cancel</label>
												<button id="save_payment_address" type="submit" style="width: 150px;">Add Address</button>
											</div>
										</div>
										<!-- End #new-address -->

									</div>
									<!-- End .panel-body -->
								</div>
								<!-- End #collapse-payment-address -->
							</div>
							<!-- End .panel -->
						</form>
					</div>

					{# payment address ends  #}
					{# shipping address starts  #}
					<div class="">
						{% if shipping_required %}
							<form action='{{shipping_address_action}}' method="post" id="shipping-form">
								<div class="panel panel-default">

									<div class="" id="collapse-shipping-address">
										<div class="panel-body address_card">

											<div class="address_existing_container">


												<div class='address_left'>
													<label class="hidden_input" style='display:none;'>
														<input
														type="radio" id="shipping_address_option" name="shipping_address_option" value="same" class="hidden_input" checked>
													<!-- {{ text_address_existing }} -->
													</label>
													<div class='address_title'>
														<strong class="panel-title">{{ text_checkout_shipping_address }}</strong>
													</div>
													<select name="shipping_address_id" id="shipping_address-select" class="mt-2" style="width:100%">
														<option value="same">{{ text_use_same_address }}</option>
														{% for address in addresses %}
															<option value="{{ address.address_id }}" {% if address.address_id == selected_shipping_address_id %} selected {% endif %}>
																{{ address.firstname }}
																{{ address.lastname }},
																{{ address.address_1 }},
																{{ address.city }},
																{{ address.postcode }}
															</option>
														{% endfor %}
													</select>
												</div>

												<div
													class="radio address_rigght">

													{# $('#new_shipping_address_btn').show(); #}
													<label class='btn-cust' class='new_shipping_address_button' id='new_shipping_address_btn'>
														<input type="radio" name="shipping_address_option" value="new" class='hidden_input'>
														Add Address
													</label>
												</div>

											</div>

											<div
												id="new-shipping-address-form" class='new_address_form' style="display: none;">
												{# <h4>{{ text_address_new }}</h4> #}

												<div class="row">
													<div class="col-md-4">
														<div class="form-group">
															<label for="input-shipping-firstname">{{ entry_firstname }}</label>
															<input type="text" name="firstname" id="input-shipping-firstname" class="form-control" placeholder="{{ entry_firstname }}">
														</div>
													</div>
													<div class="col-md-4">
														<div class="form-group">
															<label for="input-shipping-lastname">{{ entry_lastname }}</label>
															<input type="text" name="lastname" id="input-shipping-lastname" class="form-control" placeholder="{{ entry_lastname }}">
														</div>
													</div>
													    	<!-- Telephone full width -->
													<div class='col-md-4'>
        												<div class="form-group">
        													<label for="input-telephone">{{ entry_telephone }}</label>
        													<input type="text" name="custom_field[address][3]" id="input-telephone" class="form-control" placeholder="{{ entry_telephone }}">
        												</div>
													</div>
												</div>

												<input
												style="display:none;" type="text" name="company" value="example">

												<!-- Address 1 & Address 2 vertically stacked -->
												<div class="form-group">
													<label for="input-shipping-address">{{ entry_address_1 }}</label>
													<input type="text" name="address_1" id="input-shipping-address" class="form-control" placeholder="{{ entry_address_1 }}">
												</div>
												<div class="form-group">
													<label for="input-shipping-address2">{{ entry_address_2 }}</label>
													<input type="text" name="address_2" id="input-shipping-address2" class="form-control" placeholder="{{ entry_address_2 }}">
												</div>
											
												<!-- Postcode & City side by side -->
												<div class="row">
												    <div class="col-md-6">
														<div class="form-group">
															<label for="input-shipping-country">{{ entry_country }}</label>
															<select name="country_id" id="input-shipping-country" class="form-control">
															{% for country in countries %}
																{% if country.country_id == 99 %}
																	<option value="{{ country.country_id }}" selected="selected">{{ country.name }}</option>
																{% else %}
																	<option value="{{ country.country_id }}">{{ country.name }}</option>
																{% endif %}
															{% endfor %}
														    </select>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="input-shipping-postcode">{{ entry_postcode }}</label>
															<input type="text" name="postcode" id="input-shipping-postcode" class="form-control" placeholder="{{ entry_postcode }}">
														</div>
													</div>
												
												</div>


												<!-- Country & Zone (State) side by side -->
												<div class="row">
													
													<div class="col-md-6">
														<div class="form-group">
															<label for="input-shipping-city">{{ entry_city }}</label>
															<input type="text" name="city" id="input-shipping-city" class="form-control" placeholder="{{ entry_city }}" readonly>
														</div>
													</div>
													<div class="col-md-6">
														<div class="form-group">
															<label for="input-shipping-zone">{{ entry_zone }}</label>
																<div class="">
															<!-- Visible field for State Name -->
															<input
															type="text" placeholder="{{ entry_zone }}" id="input-shipping-zone_name" class="form-control" readonly/>

															<!-- Hidden input for Zone ID (important for database) -->
															<input type="hidden" name="zone_id" id="input-shipping-zone"/>
														</div>
														</div>
														<div class="address_button_container">
															<label for="shipping_address_option" class="address_cancel">Cancel</label>
															<button id='save_shipping_address' style='width:150px; display:none ' type='submit'>Add Address</button>
														</div>
													</div>
												</div>

											</div>
										</div>
									</div>

								</div>
							</form>
						{% endif %}
						{# shipping address ends  #}
						<div class="">
							<div
								class="panel panel-default border-0">
								{# <div class="panel-heading"></div> #}
								<div class="">
									<div class='cart_heading'>
										<h4 class="panel-title">
											<i class="fa fa-shopping-cart"></i>
											{{ text_cart }}
										</h4>
									</div>
									<div class="table-responsive">
										<table class="table  align-middle" style='font-size:14px;'>
											<thead class="table-light">
												<tr>
													<th style='text-align:center;'>{{ column_name }}</th>
													<th style='width:115px;'>{{ column_quantity }}</th>
													<th>{{ column_price }}</th>
													<th style='width:95px;'>Sub-Total</th>
													<th>Courier
														<br>Charges</th>
													<th>{{ column_total }}</th>
													<th></th>
												</tr>
											</thead>
											<tbody>
												{% for product in products %}
													<tr>
														<td class="align-items-center" style='display: grid !important; grid-template-columns: 50px auto; gap: 5px; text-align:left;'>
															<img src="{{ product.thumb }}" alt="{{ product.name }}" width="50">
															{{ product.name }}
														</td>

														<td class="text-left">
															<div class="input-group btn-block" style="max-width: 200px;">
																<span class="input-group-btn"></span>

																<div style="display: flex; align-items: center;">
																	<button type="button" class="quantity_button" data-action="decrease" data-cart-id="{{ product.cart_id }}">-</button>

																	<input type="number" id="{{ product.cart_id }}" name="quantity[{{ product.cart_id }}]" value="{{ product.quantity }}" min="1" class="control-quantity" data-cart-id="{{ product.cart_id }}"/>

																	<button type="button" class="quantity_button" data-action="increase" data-cart-id="{{ product.cart_id }}">+</button>
																</div>
															</div>
														</td>

														<td>{{ product.price }}</td>
														<td>{{ product.total }}</td>
													<td>
													    <input type="hidden" name="courier_charges" value="{{ (product.courier_charges == 0 ? 50 : product.courier_charges)|number_format(0) }}">

  {% if product.quantity > product.free_charges %}
    <span style="text-decoration: line-through; color: gray;">
  ₹{{ (product.courier_charges == 0 ? 50 : product.courier_charges)|number_format(0) }}

    </span>
    <span style="font-weight: bold;margin-left:5px;">₹0</span>
  {% else %}
    <span style="font-weight: bold;">{{ product.courier_charges ?: 50 }}</span>
  {% endif %}
</td>

														<td>{{ product.grand_total }}</td>
														<td>
															<span class="input-group-btn">

																<button type="button" data-toggle="tooltip" title="{{ button_remove }}" class="btn remove_product" style='color:red; background:transparent; padding:0px; font-size:20px;' data-productid="{{ product.cart_id }}">
																	<i class="fa fa-trash"></i>
																</button>
															</span>
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>


				</div>
				<div class="col-sm-4">
					<!-- shopping cart -->
					{# <form action={{cart_edit_action}} method="post" enctype="multipart/form-data"> #}
						<div>
							<div class="text-right price_section"> <div class='price_heading'>
								Price Details
							</div>
							<div class='price_rows'>
								<span>{{ text_sub_total }}:</span>
								{{ sub_total }}</div>
								{% if first_Purchase %}
							<div class='price_rows'>
								<span>{{ text_first_purchase }}:</span>
								<span class='first_Purchase'>
								    
								{{first_Purchase_percentage}}% off ₹{{ first_Purchase }}
								</span>
								</div>
								{% endif %}
							
							<div class='price_rows'>
								<span>Courier Charges</span>
								{{ courierCharges  }}</div>
							<div class='price_bottom'>
								<div class='price_rows'>
									<span>{{ text_total }}:</span>
									{{ grand_total  }}</div>
							</div>
						</div>


						<div>
							<div
								class="">
								<!-- Voucher Code Panel -->
								<div
									class="panel panel-default">
									{# <div class="panel-heading">
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																		Enter coupon Code
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																	</div> #}
									<div class="panel-body coupon_section">
										<div class="input-group">
											<input type="text" class="form-control" placeholder="coupon code">
											<span class="input-group-btn">
												<button class="btn btn-default coupon_button" type="button">Apply coupon</button>
											</span>
										</div>
										<div class="input-group mt-2">
											<input type="text" class="form-control" placeholder="Voucher code">
											<span class="input-group-btn">
												<button class="btn btn-default coupon_button" type="button">Apply Voucher</button>
											</span>
										</div>
									</div>
								</div>
							</div>
						</div>
						{# </form> #}

						<div class="">

							<form action='index.php?route=checkout/confirm' id="checkout_form" method="post">
								<input type="hidden" name="payment_address" value="existing">
								<input id='new_payment' type="hidden" name="payment_address_id" value="3">
								<input type="hidden" name="shipping_address" value="existing">
								<input id='new_shipping' type="hidden" name="shipping_address_id" value="4">

								<div class="panel panel-default payment_method_container" style='margin-bottom:0px;'>
									<div class="panel-heading payment_heading">
										<h4
											class="panel-title">
											 {#<a data-toggle="collapse" data-parent="#accordion" href="#collapse-payment-method" class="accordion-toggle">#}
											{#{{ text_checkout_payment_method }}#}
											{#<i class="fa fa-caret-down"></i>#}
											{#</a> #}
											{{ text_checkout_payment_method }}
										</h4>
									</div>
									<div id="collapse-payment-method" class="panel-collapse collapse in">
										<div class=" payment_method_custom">
												{% for key, payment_method in payment_methodsss %}
													<div class="radio">
														<label class='payment_option_label'>
															<input type="radio" name="payment_method" value="{{ payment_method.code }}" {% if payment_method.code == 'cod' %} checked {% endif %}>
															{{ payment_method.title }}
														</label>
													</div>
												{% endfor %}
											<!-- Add textarea if you want to get comments -->
											<div
												class="form-group">
												{# <label>{{ text_agree }}</label> #}
												<textarea name="comment" class="form-control" placeholder="Add any comments for your order..."></textarea>
											</div>
											<div class="form-group">
												<div class="checkbox">
													<label class='payment_option_label'>
														<input type="checkbox" name="agree" value="1" id="agree">
														<span style='font-size:14px;'>
															<span style='line-height:16px;'>
																I have read and agree to the
															</span>
															<a href="index.php?route=information/information/agree&information_id=3" class="agree">
																<b>Terms & Conditions</b>
															</a>
														</span>
													</label>
												</div>
											</div>

										</div>
									</div>
									<div style='display:flex; justify-content:end; margin-top:5px;'>
										<button id='checkout_confirm' type="submit" style="background-color:#953A93; color: white; border: none; width: 150px; height: 40px; border-radius:5px; width: 100%;
																																																																																																																																																																					    font-weight: 600;">Confirm Order</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</form>
			</div>
		</div>
		{# <div id="confirm_section"></div> #}
<script>
function changeQuantity(cartId, delta) {
const input = document.getElementById('quantityInput_' + cartId);
let currentValue = parseInt(input.value) || 1;
let newValue = currentValue + delta;

if (newValue < parseInt(input.min)) 
return;
input.value = newValue;
// Submit the corresponding form
document.getElementById('quantityForm_' + cartId).submit();
}
</script>
<script>
function removeProduct(cartId) {

const formData = new FormData();
formData.append('key', cartId);

fetch('index.php?route=checkout/cart/remove', {
method: 'POST',
body: new URLSearchParams(formData)
}).then(res => res.json()).then(data => {
if (data.success) {
// Update each product row
// alert('product updated');
window.location.reload();
} else {
console.log(data);
alert(data.error || 'Could not update cart.');
}
}).catch(err => {
console.error('Error updating cart:', err);
});
}

const products = document.querySelectorAll('.remove_product');
products.forEach((product) => {

product.addEventListener('click', () => {
const product_id = product.getAttribute('data-productid');
removeProduct(product_id);
});
});
// remove product ends
function updateProductQuandity(product_id) {
const input = document.getElementById(product_id);
const quantity = input.value;

// Create FormData object for the updated quantity
const formData = new FormData();
formData.append('quantity[' + product_id + ']', quantity);

// Send a request to update the cart quantity
fetch('index.php?route=checkout/checkout_test/updateProductQuandity', {
method: 'POST',
body: new URLSearchParams(formData)
}).then(res => res.json()).then(data => {
if (data.success) { // Instead of reloading, you can update the UI here if needed
console.log('Product updated successfully.');
 location.reload();
// Optionally update cart totals or product rows dynamically
} else {
console.log(data);
alert(data.error || 'Could not update cart.');
}
}).catch(err => {
console.error('Error updating cart:', err);
});
}

// Handle input blur (user changes quantity directly)
document.querySelectorAll('.control-quantity').forEach((input) => {
 input.dataset.prev = input.value;
input.addEventListener('input', () => {

    const product_id = input.getAttribute('data-cart-id');
        const quantity = parseInt(input.value);
        const prev = parseInt(input.dataset.prev);

        if (isNaN(quantity) || quantity <= 0) {
            alert('Quantity cannot be 0 or less.');
            input.value=prev;
            return;
        }

        if (quantity === prev) {
            // No change in quantity
            return;
        }

    updateProductQuandity(product_id);
   
});

});

// Handle button click for +/- (increase or decrease quantity)
document.querySelectorAll('.quantity_button').forEach((button) => {
button.addEventListener('click', () => {
const product_id = button.getAttribute('data-cart-id');
const action = button.getAttribute('data-action');
const input = document.getElementById(product_id);
let currentValue = parseInt(input.value) || 1;

// Increase or decrease quantity
let newValue = action === 'increase' ? currentValue + 1 : currentValue - 1;

// Prevent quantity from going below 1
if (newValue < parseInt(input.min || 1)) 
return;



// Update the input field with the new value
input.value = newValue;

// Update the cart by calling the same update function
updateProductQuandity(product_id);
});
});
		</script>
		<script>
			// document.querySelectorAll(".control-quantity").forEach(function (input) {
// input.addEventListener("blur", function () {

// console.log('quantity updated');
// this.closest("form").submit();
// });
// });</script><script>
$('#save_payment_address').on('click', function (e) {
e.preventDefault();

const formData = $('#payment-form').serialize();

$.post('index.php?route=checkout/payment_address/save', formData, function (response) {
if (! response.error) { // Set the returned address_id to hidden field in confirm form
$('input[name="payment_address_id"]').val(response.address_id);
// $('input[name="shipping_address_id"]').val(response.address_id);
confirm_button.disabled = false;
console.log(response);
location.reload();
} else { // show error messages
}
}, 'json');
});

// new shipping address
$('#save_shipping_address').on('click', function (e) {
e.preventDefault();

const formData = $('#shipping-form').serialize();

$.post('index.php?route=checkout/shipping_address/save', formData, function (response) {
if (! response.error) {
// Set the returned address_id to hidden field in confirm form
// $('input[name="shipping_address_id"]').val(response.address_id);
confirm_button.disabled = false;
console.log(response);
location.reload();
} else { // show error messages
}
}, 'json');
});
// adding default address id to hidden form
document.getElementById("new_shipping").value = document.getElementById("shipping_address-select").value;
document.getElementById("new_payment").value = document.getElementById("existing_address_id").value;

// on change address id
document.getElementById("shipping_address-select").addEventListener('change', () => {
document.getElementById("new_shipping").value = document.getElementById("shipping_address-select").value;
});
document.getElementById("shipping_address-select").addEventListener('change', () => { // console.log(document.getElementById("existing_address_id").value);
document.getElementById("new_payment").value = document.getElementById("existing_address_id").value;
});
// console.log(document.getElementById("new_shipping_method").value, document.getElementById("new_payment").value);</script><script type="text/javascript">

const confirm_button = document.getElementById('checkout_confirm');
const save_payment_address = document.getElementById('save_payment_address');
const save_shipping_address = document.getElementById('save_shipping_address');
const new_address = document.getElementById('new_address');
console.log(save_shipping_address, "shipping button");
<!--
$('input[name="payment_address"]').on('change', function () {
    if (this.value === 'new') {
        save_payment_address.style.display = 'block';
        confirm_button.style.cursor = 'no-drop';
        confirm_button.disabled = true;

        // $('#existing-address').hide();

        // Always set both buttons
        $('#shipping_address_option').prop('checked',true);
        $('#new_payment_address_button').hide();
        $('#new-shipping-address-form').hide();
        $('#new-address').show();
        $('#new_shipping_address_btn').show();
    } else {
        save_payment_address.style.display = 'none';
        confirm_button.disabled = false;
        confirm_button.style.cursor = 'pointer';

        $('#new_payment_address_button').show();
        $('#new-address').hide();
        $('#existing-address').show();

        // Reset shipping address button visibility
        $('#new-shipping-address-form').hide();
        $('#new_shipping_address_btn').show();
    }
});

$('input[name="shipping_address_option"]').on('change', function () {
    if (this.value === 'new') {
        save_shipping_address.style.display = 'block';
        $('#billingAddressExisting').prop('checked',true)

        $('#new_shipping_address_btn').hide();
        $('#new-address').hide();
        $('#new-shipping-address-form').show();

        // Always set both buttons
        confirm_button.style.cursor = 'no-drop';
        confirm_button.disabled = true;
        $('#new_payment_address_button').show();
    } else {
        save_shipping_address.style.display = 'none';

        $('#new_shipping_address_btn').show();
        $('#shipping_address-select').show();
        $('#new-shipping-address-form').hide();

        confirm_button.disabled = false;
        confirm_button.style.cursor = 'pointer';

        // Reset payment address button visibility
        $('#new_payment_address_button').show();
    }
});


const payment_method_a = document.querySelector(`input[name="payment_method"]:checked`).value;
$('#checkout_confirm').on('click', function (e) {
    e.preventDefault();

    const formData = $('#checkout_form').serialize();
    const rawForm = $('#checkout_form').serializeArray();
    const formDataObj = {};

    // Convert serialized array to object for easy manipulation
    rawForm.forEach(item => {
        formDataObj[item.name] = item.value;
    });

    // 1. Save Payment Address
    const paymentData = { ...formDataObj };
    paymentData.address_id = paymentData.payment_address_id;

    $.post('index.php?route=checkout/payment_address/save', $.param(paymentData), function (response) {
        if (!response.error) {
            // 2. Save Shipping Address
            const shippingData = { ...formDataObj };
            shippingData.address_id = shippingData.shipping_address_id;

            $.post('index.php?route=checkout/shipping_address/save', $.param(shippingData), function (response) {
                if (!response.error) {
                    $.post('index.php?route=checkout/payment_method/save', formData, function (response) {
                        if (!response.error) {
                             const testing = { ...formDataObj };
            testing.testing = 'testing the data';
                            $.post('index.php?route=checkout/confirm', $.param(testing), function (response) {
                                if (!response.error) {
                                            // alert('Order is confirmed');
                                    $.post(`index.php?route=extension/payment/${payment_method_a}/confirm`, formData, function (response) {
                                        if (!response.error) {
                                            alert('Order is confirmed');
                                            console.log(response,'order response');
                                            window.location.href = "https://localhost/sagar/index.php?route=checkout/success";
                                            if (response.redirect) {
                                                window.location.href = response.redirect;
                                            } else {
                                                console.log('No redirect provided.');
                                            }
                                        } else {
                                            console.log('Final confirm error:', response.error);
                                            alert('There was an error confirming the order.');
                                        }
                                    });
                                } else {
                                    alert('There was a problem confirming the order.');
                                }
                            });
                        } else {
                            alert('There was a problem saving the payment method.');
                        }
                    });
                } else {
                    alert('There was a problem saving the shipping address.');
                }
            });
        } else {
            alert('There was a problem saving the payment address.');
        }
    });
});

		</script>
	

	{% endif %}
	
	<script>
				$(document).ready(function () {
console.log("jQuery DOM Ready ✅");

$(document).on('change', 'input[name="shipping_address_option"]', function () {
if ($(this).val() === 'new') {
console.log("User selected NEW address ✅");
setupAddressHandlers();
}
});

function setupAddressHandlers() {
const pincodeInput = document.querySelector("#input-shipping-postcode");
const cityInput = document.querySelector("#input-shipping-city");
const zoneInput = document.querySelector("#input-shipping-zone_name"); // visible input (state name)
const zoneIdInput = document.querySelector("#input-shipping-zone"); // hidden input (zone_id)
const countrySelect = document.querySelector("#input-shipping-country");

if (! pincodeInput) {
console.error("Pincode input not found! ❌");
return;
}

if (countrySelect) {
countrySelect.value = "99"; // Set India
}pincodeInput.removeEventListener('blur', pincodeBlurHandler);
pincodeInput.addEventListener('blur', pincodeBlurHandler);

function pincodeBlurHandler() {
console.log("Pincode field blurred ✅", pincodeInput.value);

let pincode = pincodeInput.value.trim();

if (/^\d{6}$/.test(pincode)) {
console.log("Valid 6-digit pincode ✅:", pincode);

fetch(`httpss://api.postalpincode.in/pincode/${pincode}`).then(response => response.json()).then(data => {
console.log("API Response:", data);

if (data[0].Status === "Success") {
let postOffice = data[0].PostOffice[0];
let city = postOffice.District;
let stateName = postOffice.State;

if (cityInput) 
cityInput.value = city;



if (zoneInput) 
zoneInput.value = stateName;


// show state name

if (stateName) {
fetch('index.php?route=custom/zone&state=' + encodeURIComponent(stateName)).then(response => response.json()).then(zoneData => {
if (zoneData.zone_id) {
if (zoneIdInput) 
zoneIdInput.value = zoneData.zone_id;


// save real zone_id
console.log("Fetched Zone ID ✅:", zoneData.zone_id);
} else {
console.warn("Zone ID not found ❗", stateName);
if (zoneIdInput) 
zoneIdInput.value = "";



}
}).catch(err => {
console.error('Error fetching zone_id ❌', err);
if (zoneIdInput) 
zoneIdInput.value = "";



});
} else {
if (zoneIdInput) 
zoneIdInput.value = "";



}
} else {
alert("Invalid Pincode. Please check and enter again.");
if (cityInput) 
cityInput.value = '';



if (zoneInput) 
zoneInput.value = '';



if (zoneIdInput) 
zoneIdInput.value = "";



}
}).catch(error => {
console.error("API Fetch Error ❌", error);
alert("Failed to fetch pincode details. Try again later.");
});
} else {
console.warn("Invalid pincode format ❗", pincode);
}
}
}
});
			</script>
	<script>
				$(document).ready(function () {
console.log("jQuery DOM Ready ✅");

$(document).on('change', 'input[name="payment_address"]', function () {
if ($(this).val() === 'new') {
console.log("User selected NEW address ✅");
setupAddressHandlers();
}
});

function setupAddressHandlers() {
const pincodeInput = document.querySelector("#input-postcode");
const cityInput = document.querySelector("#input-city");
const zoneInput = document.querySelector("#input-payment-zone_name"); // visible input (state name)
const zoneIdInput = document.querySelector("#input-payment-zone"); // hidden input (zone_id)
const countrySelect = document.querySelector("#input-country");

if (! pincodeInput) {
console.error("Pincode input not found! ❌");
return;
}

if (countrySelect) {
countrySelect.value = "99"; // Set India
}pincodeInput.removeEventListener('blur', pincodeBlurHandler);
pincodeInput.addEventListener('blur', pincodeBlurHandler);

function pincodeBlurHandler() {
console.log("Pincode field blurred ✅", pincodeInput.value);

let pincode = pincodeInput.value.trim();

if (/^\d{6}$/.test(pincode)) {
console.log("Valid 6-digit pincode ✅:", pincode);

fetch(`https://api.postalpincode.in/pincode/${pincode}`).then(response => response.json()).then(data => {
console.log("API Response:", data);

if (data[0].Status === "Success") {
let postOffice = data[0].PostOffice[0];
let city = postOffice.District;
let stateName = postOffice.State;

if (cityInput) 
cityInput.value = city;



if (zoneInput) 
zoneInput.value = stateName;


// show state name

if (stateName) {
fetch('index.php?route=custom/zone&state=' + encodeURIComponent(stateName)).then(response => response.json()).then(zoneData => {
if (zoneData.zone_id) {
if (zoneIdInput) 
zoneIdInput.value = zoneData.zone_id;


// save real zone_id
console.log("Fetched Zone ID ✅:", zoneData.zone_id);
} else {
console.warn("Zone ID not found ❗", stateName);
if (zoneIdInput) 
zoneIdInput.value = "";



}
}).catch(err => {
console.error('Error fetching zone_id ❌', err);
if (zoneIdInput) 
zoneIdInput.value = "";



});
} else {
if (zoneIdInput) 
zoneIdInput.value = "";



}
} else {
alert("Invalid Pincode. Please check and enter again.");
if (cityInput) 
cityInput.value = '';



if (zoneInput) 
zoneInput.value = '';



if (zoneIdInput) 
zoneIdInput.value = "";



}
}).catch(error => {
console.error("API Fetch Error ❌", error);
alert("Failed to fetch pincode details. Try again later.");
});
} else {
console.warn("Invalid pincode format ❗", pincode);
}
}
}
});
			</script>
			
			
			
			
			
			
			
			
			 <button type="button" class="btn btn-primary search-camera" id='visualSearch_button' style="margin-left: 10px; width:50px; height:50px;">
          <i class="fa fa-camera"></i>
        </button>
			
			 <!-- Visual Search Modal -->
  <div class="modal fade" id="visualSearchModal" tabindex="-1" role="dialog" aria-labelledby="visualSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close pull-right" aria-label="Close" id='sample_modal_close'><i class="fa fa-times" aria-hidden="true"></i>
</button>
        </div>
        <div class="modal-body">
          <h5 class="modal-title" id="visualSearchModalLabel">{{ text_visual_search|default('Try Visual Search') }}</h5>
          <p class="modal-subtitle">{{ text_search_with_image|default('Search with a picture instead of text') }}</p>

          <form id="visual-search-form" method="post" enctype="multipart/form-data">
            <div class="interaction-box">
              <i class="fas fa-info-circle info-icon" title="Drag and drop images here to search"></i>
              <div class="drop-zone-prompt">
                <i class="fa fa-cloud-upload-alt mr:1px"></i>
                <span>
                  Drag one or more images here or 
                  <span class="browse-text" onclick="document.getElementById('fileInput').click()">browse</span>
                </span>
                <input type="file" id="fileInput" name="file" style="display: none;" accept="image/">
              </div>

              <div class="divider">OR</div>

              <div class="action-buttons">
                 
              <div id="take-photo-container">
    <button type="button" id="take-photo-btn" class="btn" style="width: 315px;">
      <i class="fa fa-camera"></i> Take photo
    </button>
  </div>

              </div>
            </div>

            <input type="hidden" name="image_base64" id="image-base64" />

            <video id="video" class="video-feed" style="display: none;" autoplay></video>
            <canvas id="canvas" class="canvas-feed" style="display: none;"></canvas>
            <canvas id="capture-canvas" width="640" height="480" style="display: none;"></canvas>

            <p class="sample-images-title">Click a sample image to try it</p>

            <div class="sample-images">
              <div class="row" style="margin-bottom: 15px;">
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample9.jpg" class="img-responsive sample-img" alt="Sample 1" data-url="catalog/view/theme/so-revo/images/bg/sample9.jpg">
                </div>
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample10.jpg" class="img-responsive sample-img" alt="Sample 2" data-url="catalog/view/theme/so-revo/images/bg/sample10.jpg">
                </div>
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample11.jpg" class="img-responsive sample-img" alt="Sample 3" data-url="catalog/view/theme/so-revo/images/bg/sample11.jpg">
                </div>
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample12.jpg" class="img-responsive sample-img" alt="Sample 4" data-url="catalog/view/theme/so-revo/images/bg/sample12.jpg">
                </div>
              </div>
              <div class="row">
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample13.jpg" class="img-responsive sample-img" alt="Sample 5" data-url="catalog/view/theme/so-revo/images/bg/sample13.jpg">
                </div>
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample14.jpg" class="img-responsive sample-img" alt="Sample 6" data-url="catalog/view/theme/so-revo/images/bg/sample14.jpg">
                </div>
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample15.jpg" class="img-responsive sample-img" alt="Sample 7" data-url="catalog/view/theme/so-revo/images/bg/sample15.jpg">
                </div>
                <div class="col-xs-3">
                  <img src="catalog/view/theme/so-revo/images/bg/sample16.jpg" class="img-responsive sample-img" alt="Sample 8" data-url="catalog/view/theme/so-revo/images/bg/sample16.jpg">
                </div>
              </div>
            </div>
          </form>

          <div class="learn-more-link">
            <a href="#">{{ text_learn_more|default('Learn more') }}</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
			
			


  <script type="text/javascript">
  // Use jQuery and Bootstrap 3.3.5 modal methods
  $(document).ready(function() {
    // Visual search button click handler
    $('#visualSearch_button').on('click', function() {
      $('#visualSearchModal').modal('show');
    });
    
    // Close button click handler
    $('#sample_modal_close').on('click', function() {
      $('#visualSearchModal').modal('hide');
    });
  });
  
  if (typeof jQuery == 'undefined') {
    document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
  }

  (function($) {
    $.fn.Soautocomplete = function(option) {
      return this.each(function() {
        this.timer = null;
        this.items = new Array();

        $.extend(this, option);

        $(this).attr('autocomplete', 'off');

        $(this).on('focus', function() {
          this.request();
        });

        $(this).on('blur', function() {
          setTimeout(function(object) {
            object.hide();
          }, 200, this);
        });

        $(this).on('keydown', function(event) {
          switch(event.keyCode) {
            case 27:
              this.hide();
              break;
            default:
              this.request();
              break;
          }
        });

        this.click = function(event) {
          event.preventDefault();
          value = $(event.target).parent().attr('data-value');
          if (value && this.items[value]) {
            this.select(this.items[value]);
          }
        }

        this.show = function() {
          var pos = $(this).position();
          $(this).siblings('ul.dropdown-menu').css({
            top: pos.top + $(this).outerHeight(),
            left: pos.left
          });
          $(this).siblings('ul.dropdown-menu').show();
        }

        this.hide = function() {
          $(this).siblings('ul.dropdown-menu').hide();
        }

        this.request = function() {
          clearTimeout(this.timer);
          this.timer = setTimeout(function(object) {
            object.source($(object).val(), $.proxy(object.response, object));
          }, 200, this);
        }

        this.response = function(json) {
          html = '';
          if (json.length) {
            for (i = 0; i < json.length; i++) {
              this.items[json[i]['value']] = json[i];
            }

            for (i = 0; i < json.length; i++) {
              if (!json[i]['category']) {
                html += '<li class="media" data-value="' + json[i]['value'] + '" title="' + json[i]['label'] + '">';
                if(json[i]['image'] && json[i]['show_image'] && json[i]['show_image'] == 1 ) {
                  html += '	<a class="media-left" href="' + json[i]['link'] + '"><img class="pull-left" src="' + json[i]['image'] + '"></a>';
                }

                html += '<div class="media-body">';
                html += '<a href="' + json[i]['link'] + '" title="' + json[i]['label'] + '"><span>' +json[i]['cate_name'] + json[i]['label'] + '</span></a>';
                if(json[i]['price'] && json[i]['show_price'] && json[i]['show_price'] == 1){
                  html += '	<div class="box-price">';
                  if (!json[i]['special']) {
                    html += '<span class="price">'+json[i]['price']+'</span>';
                  } else {
                    html += '</span><span class="price-new">' + json[i]['special'] + '</span>'+'<span class="price-old" style="text-decoration:line-through;">' + json[i]['price']  ;
                  }
                  html += '	</div>';
                }
                html += '</div></li>';
                html += '<li class="clearfix"></li>';
              }
            }

            var category = new Array();
            for (i = 0; i < json.length; i++) {
              if (json[i]['category']) {
                if (!category[json[i]['category']]) {
                  category[json[i]['category']] = new Array();
                  category[json[i]['category']]['name'] = json[i]['category'];
                  category[json[i]['category']]['item'] = new Array();
                }
                category[json[i]['category']]['item'].push(json[i]);
              }
            }

            for (i in category) {
              html += '<li class="dropdown-header">' + category[i]['name'] + '</li>';
              for (j = 0; j < category[i]['item'].length; j++) {
                html += '<li data-value="' + category[i]['item'][j]['value'] + '"><a href="#">   ' + category[i]['item'][j]['label'] + '</a></li>';
              }
            }
          }

          if (html) {
            this.show();
          } else {
            this.hide();
          }

          $(this).siblings('ul.dropdown-menu').html(html);
        }

        $(this).after('<ul class="dropdown-menu"></ul>');
      });
    }
  })(window.jQuery);

    // Function to handle sample image clicks
    function setupSampleImageClicks() {
      const sampleImages = document.querySelectorAll('.sample-img');
      
      sampleImages.forEach(img => {
        img.addEventListener('click', function() {
          // Get the image URL from data attribute
          const imageUrl = this.getAttribute('data-url');
          if (imageUrl) {
            // Show loading overlays with engaging messages
            showFullPageLoading('Processing sample image...');
            
            // Submit the image URL for processing
            submitFormWithUrl(imageUrl);
          }
        });
      });
    }
    
    $(document).ready(function() {
      // Setup sample image click handlers
      setupSampleImageClicks();
    var selector = '#search{{ module }}';
    var total = 0;
    var showimage = {{ showimage|default(0) }};
    var showprice = {{ showprice|default(0) }};
    var character = {{ character|default(3) }};
    var height = {{ height|default(50) }};
    var width = {{ width|default(50) }};

    $(selector).find('input[name=\'search\']').Soautocomplete({
      delay: 500,
      source: function(request, response) {
        var category_id = $(".select_category select[name=\"category_id\"]").first().val();
        if(typeof(category_id) == 'undefined')
          category_id = 0;
        var limit = {{ limit|default(10) }};
        if(request.length >= character){
          $.ajax({
            url: 'index.php?route=extension/module/so_searchpro/autocomplete&filter_category_id='+category_id+'&limit='+limit+'&width='+width+'&height='+height+'&filter_name='+encodeURIComponent(request),
            dataType: 'json',
            success: function(json) {
              response($.map(json, function(item) {
                total = 0;
                if(item.total){
                  total = item.total;
                }

                return {
                  price:   item.price,
                  special: item.special,
                  tax:     item.tax,
                  label:   item.name,
                  cate_name:   (item.category_name) ? item.category_name + ' > ' : '',
                  image:   item.image,
                  link:    item.link,
                  minimum:    item.minimum,
                  show_price:  showprice,
                  show_image:  showimage,
                  value:   item.product_id,
                }
              }));
            }
          });
        }
      },
    });

    const dropZone = document.querySelector(".drop-zone-prompt");
    const fileInput = document.getElementById('fileInput');

    if (dropZone && fileInput) {
      // Ensure the dropzone is properly initialized
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add("drop-zone--over");
      });

      ["dragleave", "dragend"].forEach((type) => {
        dropZone.addEventListener(type, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("drop-zone--over");
        });
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("drop-zone--over");
        
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          console.log("Files dropped:", fileInput.files);
          // Show the bubble loader with engaging messages
          showFullPageLoading('Processing your dropped image...');
          submitForm();
        }
      });

      // Make the entire drop zone clickable to open file browser
      dropZone.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", () => {
        if (fileInput.files.length) {
          console.log("Files selected:", fileInput.files);
          // Show the bubble loader with engaging messages
          showFullPageLoading('Processing your image... Please wait');
          submitForm();
        }
      });
    }

    $("#paste-image-btn").on("click", () => {
      const container = document.getElementById('paste-url-container');
      container.innerHTML = '';

      const inputGroup = document.createElement('div');
      inputGroup.className = 'url-input-container';

      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.id = 'image-url-input';
      urlInput.name = 'image_url';
      urlInput.className = 'form-control';
      urlInput.placeholder = 'Paste image URL';
      urlInput.autofocus = true;

      const submitButton = document.createElement('button');
      submitButton.type = 'button';
      submitButton.className = 'submit-url-btn';
      submitButton.innerHTML = '<i class="fa fa-search"></i>';

      inputGroup.appendChild(urlInput);
      inputGroup.appendChild(submitButton);
      container.appendChild(inputGroup);

      urlInput.focus();

      try {
        navigator.clipboard.readText().then(function(text) {
          urlInput.value = text;
        }).catch(function(err) {

        });
      } catch (err) {

      }

      submitButton.addEventListener('click', () => {
        const url = urlInput.value.trim();
        if (url) {
          // Show the bubble loader with engaging messages
          showFullPageLoading('Processing image from URL...');
          submitFormWithUrl(url);
        } else {
          alert('Please enter a valid URL.');
        }
      });

      urlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const url = urlInput.value.trim();
          if (url) {
            // Show the bubble loader with engaging messages
            showFullPageLoading('Processing image from URL...');
            submitFormWithUrl(url);
          } else {
            alert('Please enter a valid URL.');
          }
        }
      });
    });

    // Bing-style camera implementation
    $("#take-photo-btn").on("click", async () => {
      try {
        // Hide the modal first using Bootstrap 3.3.5 method
        $("#visualSearchModal").modal('hide');

        // Create Bing-style camera overlay
        const cameraOverlay = document.createElement('div');
        cameraOverlay.className = 'bing-camera-overlay';
        cameraOverlay.innerHTML = `
          <div class="bing-camera-container">
            <div class="bing-camera-header">
              <div class="bing-camera-title">Take a photo</div>
              <button class="bing-camera-close">&times;</button>
            </div>
            <div class="bing-camera-video-container">
              <video class="bing-camera-video" id="bing-camera-video" autoplay playsinline></video>
              <div class="bing-camera-instruction">Drag one</div>
              <div class="bing-camera-controls">
                <div class="bing-capture-button"></div>
              </div>
              <div class="bing-side-controls">
                <button class="bing-control-btn" id="bing-flash-btn">
                  <i class="fa fa-bolt"></i>
                </button>
                <button class="bing-control-btn" id="bing-switch-btn">
                  <i class="fa fa-sync-alt"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(cameraOverlay);

        // Get camera elements
        const cameraVideo = document.getElementById('bing-camera-video');
        const captureBtn = document.querySelector('.bing-capture-button');
        const closeBtn = document.querySelector('.bing-camera-close');
        const switchBtn = document.getElementById('bing-switch-btn');
        const flashBtn = document.getElementById('bing-flash-btn');
        const canvas = document.getElementById('canvas');

        // Camera setup
        let currentFacingMode = 'environment';
        let stream = null;
        let flashEnabled = false;

        // Function to start camera
        async function startCamera(facingMode) {
          try {
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
            }
            
            // First check if we have camera permissions
            stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: facingMode,
                width: { ideal: 640 },
                height: { ideal: 480 }
              } 
            });
            
            cameraVideo.srcObject = stream;
            
            // Wait for video to be ready
            await new Promise(resolve => {
              cameraVideo.onloadedmetadata = () => {
                resolve();
              };
            });
            
            // Show the camera is active visually
            cameraVideo.style.transform = facingMode === 'user' ? 'scaleX(-1)' : 'none';
            
            // Make sure both canvas elements have correct dimensions
            const captureCanvas = document.getElementById('capture-canvas');
            captureCanvas.width = cameraVideo.videoWidth;
            captureCanvas.height = cameraVideo.videoHeight;
            
            // Also set the other canvas for compatibility
            if (canvas) {
              canvas.width = cameraVideo.videoWidth;
              canvas.height = cameraVideo.videoHeight;
            }
            

            return true;
          } catch (err) {
            console.error('Error starting camera:', err);
            alert('Unable to access camera. Please allow camera access and try again.');
            return false;
          }
        }

        // Start camera
        await startCamera(currentFacingMode);

        // Switch camera
        switchBtn.addEventListener('click', async () => {
          currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
          await startCamera(currentFacingMode);
        });

        // Flash toggle
        flashBtn.addEventListener('click', () => {
          flashEnabled = !flashEnabled;
          flashBtn.style.color = flashEnabled ? '#ffd700' : 'white';
        });

        // Capture photo
        captureBtn.addEventListener('click', async () => {
          // Disable capture button
          captureBtn.style.pointerEvents = 'none';
          captureBtn.style.opacity = '0.6';
          
          // Flash effect if enabled
          if (flashEnabled) {
            cameraOverlay.style.background = 'rgba(255, 255, 255, 0.8)';
            setTimeout(() => {
              cameraOverlay.style.background = 'rgba(0, 0, 0, 0.7)';
            }, 150);
          }
          
          try {
            // Get capture canvas and draw the image
            const captureCanvas = document.getElementById('capture-canvas');
            captureCanvas.width = cameraVideo.videoWidth;
            captureCanvas.height = cameraVideo.videoHeight;
            const ctx = captureCanvas.getContext('2d');
            ctx.drawImage(cameraVideo, 0, 0, captureCanvas.width, captureCanvas.height);
            
            // Convert to base64 image data
            const imageData = captureCanvas.toDataURL('image/jpeg', 0.9);
            document.getElementById('image-base64').value = imageData;
            
            // Create a file from the base64 data
            const dataURLtoBlob = (dataurl) => {
              const arr = dataurl.split(',');
              const mime = arr[0].match(/:(.*?);/)[1];
              const bstr = atob(arr[1]);
              let n = bstr.length;
              const u8arr = new Uint8Array(n);
              while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
              }
              return new Blob([u8arr], { type: mime });
            };
            
            // Create a File object from the blob
            const blob = dataURLtoBlob(imageData);
            const file = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
            
            // Create a new FileList-like object and assign it to the file input
            try {
              // Modern browsers support DataTransfer API
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(file);
              document.getElementById('fileInput').files = dataTransfer.files;
            } catch (err) {
              // Fallback for browsers that don't support DataTransfer
              // Store the base64 data and directly submit the form without updating the file input
            }
            
            // Show the unified loading animation
            showFullPageLoading('Processing your camera image... Please wait');
          } catch (err) {
            console.error('Error capturing image:', err);
          }
          
          // Stop camera
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          // Remove camera overlay
          setTimeout(() => {
            cameraOverlay.remove();
            submitForm();
          }, 500);
        });

        // Close camera
        closeBtn.addEventListener('click', () => {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          cameraOverlay.remove();
          
          // Reopen modal using Bootstrap 3.3.5 method
          $("#visualSearchModal").modal('show');
        });

        // Close on overlay click
        cameraOverlay.addEventListener('click', (e) => {
          if (e.target === cameraOverlay) {
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
            }
            cameraOverlay.remove();
          }
        });

      } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Unable to access camera. Please allow camera access.');
      }
    });

    $(".sample-img").on("click", function() {
      const imgSrc = $(this).attr("data-url");
      submitFormWithUrl(imgSrc);
    });

    function submitForm() {
      const form = document.getElementById('visual-search-form');
      const formData = new FormData(form);

      // Full page loading is already shown before this function is called
      // No need to show it again here
      
      $.ajax({
        url: 'https://www.ipshopy.com/api/search_by_image',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        timeout: 20000, // 20 seconds timeout
        success: function(response) {
          hideFullPageLoading();
          
          // Hide modal using Bootstrap 3.3.5 method
          $('#visualSearchModal').modal('hide');
          
          // Short delay to ensure the loading overlay is seen
          setTimeout(() => {
            redirectToSearchResults(response);
          }, 500);
        },
        error: function(xhr, status, error) {
          hideFullPageLoading();
          
          let errorMessage = 'An error occurred while processing the image.';
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMessage = xhr.responseJSON.error;
          } else if (xhr.responseText) {
            errorMessage = xhr.responseText;
          } else if (status === 'timeout') {
            errorMessage = 'The request timed out. Server might be busy. Please try again.';
          }
          
          alert(errorMessage);
        }
      });
    }

    function submitFormWithUrl(url) {
      // Show a full page loading overlay immediately
      showFullPageLoading('Processing your image... Please wait');
      
      const isImageUrl = /\.(jpeg|jpg|gif|png|webp|bmp|svg)$/i.test(url);
      
      if (isImageUrl) {
        // Set a timeout for the fetch operation
        const fetchTimeout = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Fetch timeout - URL took too long to respond')), 10000);
        });
        
        // Race between fetch and timeout
        Promise.race([
          fetch(url),
          fetchTimeout
        ])
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to fetch image (https ${response.status})`);
          }
          return response.blob();
        })
        .then(blob => {
          const formData = new FormData();
          formData.append('file', blob, 'image_from_url.jpg');
          
          $.ajax({
            url: 'https://www.ipshopy.com/api/search_by_image',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            timeout: 20000, // 20 seconds timeout
            success: function(response) {
              hideFullPageLoading();
              
              // Hide modal using Bootstrap 3.3.5 method
              $('#visualSearchModal').modal('hide');
              
              // Short delay to ensure the loading overlay is seen
              setTimeout(() => {
                redirectToSearchResults(response);
              }, 500);
            },
            error: function(xhr, status, error) {
              hideFullPageLoading();
              
              let errorMessage = 'An error occurred while processing the image.';
              if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
              } else if (xhr.responseText) {
                errorMessage = xhr.responseText;
              } else if (status === 'timeout') {
                errorMessage = 'The request timed out. Server might be busy. Please try again.';
              }
              alert(errorMessage);
            }
          });
        })
        .catch(err => {
          hideFullPageLoading();
          alert('Failed to load image from URL: ' + err.message);
        });
      } else {
        hideFullPageLoading();
        window.location.href = `index.php?route=product/visual_search&search=${encodeURIComponent(url)}`;
      }
    }

    function redirectToSearchResults(response) {
      try {
        if (response.success && response.session_id) {
          // Show full-screen loading before redirect
          const loadingOverlay = document.createElement('div');
          loadingOverlay.className = 'full-page-loading';
          loadingOverlay.style.opacity = '1'; // Make immediately visible
          loadingOverlay.innerHTML = `
            <div class="loading-container">
              <div class="bubble-loader">
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
                <div class="bubble"></div>
              </div>
              <div class="loading-text">Loading visual search results...</div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: 50%"></div>
              </div>
            </div>
          `;
          document.body.appendChild(loadingOverlay);
          
          // Create the search parameters
          const searchParams = new URLSearchParams(window.location.search);
          searchParams.set('route', 'product/visual_search');
          searchParams.set('session_id', response.session_id);
          searchParams.set('result_count', response.result_count || 0);
          
          if (!searchParams.has('search')) {
            searchParams.set('search', 'visual');
          }
          if (!searchParams.has('category_id')) {
            searchParams.set('category_id', '0');
          }
          if (!searchParams.has('submit_search')) {
            searchParams.set('submit_search', '');
          }
          // Add fromRefPage parameter if it exists in the response
          if (response.fromRefPage) {
            searchParams.set('fromRefPage', response.fromRefPage);
          }

          const redirectUrl = 'index.php?' + searchParams.toString();
          
          // Add a small delay to ensure the loading overlay is visible
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 300);
        } else {
          alert("Failed to process search results. Please try again.");
        }
      } catch (err) {
        alert("Failed to redirect to search results: " + err.message);
      }
    }

    function showModalLoading() {
      const modalBody = document.querySelector('#visualSearchModal .modal-body');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'modal-loading';
      loadingDiv.innerHTML = `
        <div class="bubble-loader">
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
          <div class="bubble"></div>
        </div>
        <div class="loading-text" id="modal-loading-message">Analyzing your image...</div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="modal-progress-bar"></div>
        </div>
      `;
      modalBody.appendChild(loadingDiv);
      
      // Set up sequence of messages
      const loadingMessages = [
        "Analyzing your image...",
        "Looking for similar products...",
        "Matching colors and patterns...",
        "Finding best matches...",
        "Almost done! Preparing results...",
        "Sorting by relevance..."
      ];
      
      let messageIndex = 0;
      let progress = 0;
      
      // Update loading message and progress bar
      const messageElement = document.getElementById('modal-loading-message');
      const progressBar = document.getElementById('modal-progress-bar');
      
      const updateMessage = setInterval(() => {
        messageIndex = (messageIndex + 1) % loadingMessages.length;
        if (messageElement) {
          messageElement.textContent = loadingMessages[messageIndex];
          
          // Update progress
          progress += (100 - progress) * 0.2;
          if (progressBar) {
            progressBar.style.width = Math.min(progress, 95) + '%';
          }
        }
      }, 2000);
      
      // Store the interval ID
      loadingDiv.dataset.intervalId = updateMessage;
      
      // Set a timeout to hide the loading after a maximum wait time
      // This prevents the loading spinner from showing indefinitely
      window.loadingTimeout = setTimeout(() => {
        hideModalLoading();
      }, 15000); // 15 seconds max loading time
    }

    function hideModalLoading() {
      // Clear the loading timeout if it exists
      if (window.loadingTimeout) {
        clearTimeout(window.loadingTimeout);
        window.loadingTimeout = null;
      }
      
      const loadingDiv = document.querySelector('.modal-loading');
      if (loadingDiv) {
        // Clear the message update interval
        if (loadingDiv.dataset.intervalId) {
          clearInterval(parseInt(loadingDiv.dataset.intervalId));
        }
        
        // Set progress to 100% before hiding
        const progressBar = document.getElementById('modal-progress-bar');
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        
        // Update message to completion
        const messageElement = document.getElementById('modal-loading-message');
        if (messageElement) {
          messageElement.textContent = "Search complete!";
        }
        
        // Add fade-out effect after showing completion
        setTimeout(() => {
          loadingDiv.style.opacity = '0';
          setTimeout(() => {
            if (loadingDiv.parentNode) {
              loadingDiv.remove();
            }
          }, 300);
        }, 500);
      }
    }
    
    function showFullPageLoading(initialMessage) {
      // Remove any existing loading overlay
      const existingOverlay = document.querySelector('.full-page-loading');
      if (existingOverlay) {
        existingOverlay.remove();
      }
      
      // Create the full page loading overlay
      const loadingOverlay = document.createElement('div');
      loadingOverlay.className = 'full-page-loading';
      loadingOverlay.style.opacity = '0';
      loadingOverlay.style.backgroundColor = '#ffffff'; // Add white background
      loadingOverlay.innerHTML = `
        <div class="loading-container">
          <div class="bubble-loader">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
          </div>
          <div class="loading-text" id="full-page-loading-message">${initialMessage || 'Analyzing your image...'}</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="full-page-progress-bar"></div>
          </div>
        </div>
      `;
      
      document.body.appendChild(loadingOverlay);
      
      // Force a reflow to enable the transition
      loadingOverlay.offsetHeight;
      
      // Fade in the overlay
      loadingOverlay.style.opacity = '1';
      
      // Set up sequence of messages
      const loadingMessages = [
        initialMessage || "Analyzing your image...",
        "Looking for similar products...",
        "Matching colors and patterns...",
        "Finding best matches...",
        "Almost done! Preparing results...",
        "Sorting by relevance..."
      ];
      
      let messageIndex = 0;
      let progress = 0;
      
      // Update loading message and progress bar
      const messageElement = document.getElementById('full-page-loading-message');
      const progressBar = document.getElementById('full-page-progress-bar');
      
      const updateMessage = setInterval(() => {
        messageIndex = (messageIndex + 1) % loadingMessages.length;
        if (messageElement) {
          messageElement.textContent = loadingMessages[messageIndex];
          
          // Update progress
          progress += (100 - progress) * 0.2;
          if (progressBar) {
            progressBar.style.width = Math.min(progress, 95) + '%';
          }
        }
      }, 2000);
      
      // Store the interval ID
      loadingOverlay.dataset.intervalId = updateMessage;
      
      // Set a timeout to hide the loading after a maximum wait time
      window.fullPageLoadingTimeout = setTimeout(() => {
        hideFullPageLoading();
      }, 30000); // 30 seconds max loading time
      
      return loadingOverlay;
    }
    
    function hideFullPageLoading() {
      // Clear the timeout if it exists
      if (window.fullPageLoadingTimeout) {
        clearTimeout(window.fullPageLoadingTimeout);
        window.fullPageLoadingTimeout = null;
      }
      
      const loadingOverlay = document.querySelector('.full-page-loading');
      if (loadingOverlay) {
        // Clear the message update interval
        if (loadingOverlay.dataset.intervalId) {
          clearInterval(parseInt(loadingOverlay.dataset.intervalId));
        }
        
        // Set progress to 100% before hiding
        const progressBar = document.getElementById('full-page-progress-bar');
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        
        // Update message to completion
        const messageElement = document.getElementById('full-page-loading-message');
        if (messageElement) {
          messageElement.textContent = "Search complete!";
        }
        
        // Fade out after showing completion
        setTimeout(() => {
          // Fade out effect
          loadingOverlay.style.opacity = '0';
          
          // Remove after animation completes
          setTimeout(() => {
            if (loadingOverlay.parentNode) {
              loadingOverlay.remove();
            }
          }, 300);
        }, 500);
      }
    }

    // Disable browser's automatic scroll restoration
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    
    // Force scroll to top on page load/refresh
    window.onload = function() {
      window.scrollTo(0, 0);
    };
    
    // Also force scroll to top immediately
    window.scrollTo(0, 0);
    
    // Function to show skeleton loaders
    function showSkeletonLoaders() {
      const skeletonLoader = document.getElementById('skeleton-loader');
      const imageSkeletonLoader = document.getElementById('image-skeleton');
      const resultsContainer = document.getElementById('results-container');
      
      // Show skeleton loaders
      if (skeletonLoader) {
        skeletonLoader.style.display = 'block';
        
        // Add message element if it doesn't exist
        if (!document.getElementById('skeleton-message')) {
          const messageElement = document.createElement('div');
          messageElement.id = 'skeleton-message';
          messageElement.className = 'skeleton-message';
          messageElement.textContent = 'Finding products that match your image...';
          skeletonLoader.appendChild(messageElement);
          
          // Add progress bar
          const progressBarContainer = document.createElement('div');
          progressBarContainer.className = 'progress-bar-container';
          progressBarContainer.innerHTML = '<div class="progress-bar" id="skeleton-progress-bar"></div>';
          skeletonLoader.appendChild(progressBarContainer);
          
          // Add CSS for skeleton message if not exists
          if (!document.getElementById('skeleton-message-style')) {
            const style = document.createElement('style');
            style.id = 'skeleton-message-style';
            style.textContent = `
              .skeleton-message {
                color: #1a73e8;
                font-size: 16px;
                font-weight: 500;
                text-align: center;
                margin-top: 20px;
                min-height: 24px;
              }
            `;
            document.head.appendChild(style);
          }
          
          // Set up sequence of messages
          const loadingMessages = [
            "Finding products that match your image...",
            "Analyzing colors and patterns...",
            "Searching for similar items...",
            "Almost there! Preparing your results...",
            "Finding the best matches for you..."
          ];
          
          let messageIndex = 0;
          let progress = 0;
          
          // Update loading message and progress bar
          const progressBar = document.getElementById('skeleton-progress-bar');
          
          const updateMessage = setInterval(() => {
            messageIndex = (messageIndex + 1) % loadingMessages.length;
            messageElement.textContent = loadingMessages[messageIndex];
            
            // Update progress
            progress += (100 - progress) * 0.2;
            if (progressBar) {
              progressBar.style.width = Math.min(progress, 95) + '%';
            }
          }, 2000);
          
          // Store the interval ID
          skeletonLoader.dataset.intervalId = updateMessage;
        }
      }
      
      if (imageSkeletonLoader) imageSkeletonLoader.style.display = 'block';
      
      // Hide results container while loading
      if (resultsContainer) resultsContainer.style.display = 'none';
      
      return true;
    }
    
    // Handle page refresh and scrolling
    window.addEventListener('beforeunload', function() {
      // Save a flag in sessionStorage to indicate page is refreshing
      sessionStorage.setItem('isRefreshing', 'true');
    });
    
    // Add scroll event listener to show skeleton on scroll-triggered refresh
    window.addEventListener('scroll', function() {
      // Only set flag if we're on a search page
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('route') === 'product/search') {
        sessionStorage.setItem('isScrolling', 'true');
      }
    });
    
    (function checkAndDisplayVisualSearchResults() {
      // Force scroll to top on initial execution
      setTimeout(function() {
        window.scrollTo(0, 0);
      }, 0);
      
      const urlParams = new URLSearchParams(window.location.search);
      const route = urlParams.get('route');
      const sessionId = urlParams.get('session_id');
      
      // Check if page is being refreshed or was scrolling
      const isRefreshing = sessionStorage.getItem('isRefreshing') === 'true';
      const wasScrolling = sessionStorage.getItem('isScrolling') === 'true';
      
      // Clear the flags
      sessionStorage.removeItem('isRefreshing');
      sessionStorage.removeItem('isScrolling');
      
      // Force scroll to top again after a very short delay
      if (route === 'product/search') {
        for (let i = 0; i < 5; i++) {
          setTimeout(function() {
            window.scrollTo(0, 0);
          }, i * 50); // Try multiple times with increasing delays
        }
      }
      
      // Always show skeleton loaders on initial load, refresh, or after scrolling
      if (route === 'product/search') {
        showSkeletonLoaders();
      }
      
      // Set a timeout to hide skeleton loader if results take too long
      let skeletonTimeout = setTimeout(() => {
        const skeletonLoader = document.getElementById('skeleton-loader');
        const imageSkeletonLoader = document.getElementById('image-skeleton');
        const resultsContainer = document.getElementById('results-container');
        
        // Clear the message update interval if it exists
        if (skeletonLoader && skeletonLoader.dataset.intervalId) {
          clearInterval(parseInt(skeletonLoader.dataset.intervalId));
        }
        
        if ((skeletonLoader && skeletonLoader.style.display !== 'none') || 
            (imageSkeletonLoader && imageSkeletonLoader.style.display !== 'none')) {
          if (skeletonLoader) skeletonLoader.style.display = 'none';
          if (imageSkeletonLoader) imageSkeletonLoader.style.display = 'none';
          
          if (resultsContainer) {
            resultsContainer.style.display = 'grid';
            resultsContainer.innerHTML = '<p>Results are taking longer than expected. Please try again.</p>';
          }
        }
      }, 10000); // 10 seconds max waiting time

      if (route === 'product/search' && sessionId) {
        try {
          let contentArea = document.getElementById('content');
          if (!contentArea) {
            contentArea = document.querySelector('.container');
          }
          if (!contentArea) {
            contentArea = document.querySelector('#product-search');
          }
          if (!contentArea) {
            contentArea = document.querySelector('main');
          }
          if (!contentArea) {
            alert("Failed to display visual search results: Content area not found.");
            return;
          }

          let visualSearchContainer = document.createElement('div');
          visualSearchContainer.className = 'visual-search-results';
          visualSearchContainer.id = 'visual-search-results';
          visualSearchContainer.innerHTML = `
            <div class="visual-search-container">
              <div class="visual-search-left" id="uploaded-image-container">
                <h3>Your Image</h3>
                <div id="image-skeleton" class="skeleton-uploaded-image"></div>
              </div>
              
              <div class="visual-search-right">
                <h3>Similar Products</h3>
                <div class="skeleton-loader" id="skeleton-loader">
                  <div class="skeleton-grid">
                    <div class="skeleton-item">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-text"></div>
                      <div class="skeleton-text short"></div>
                    </div>
                    <div class="skeleton-item">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-text"></div>
                      <div class="skeleton-text short"></div>
                    </div>
                    <div class="skeleton-item">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-text"></div>
                      <div class="skeleton-text short"></div>
                    </div>
                    <div class="skeleton-item">
                      <div class="skeleton-image"></div>
                      <div class="skeleton-text"></div>
                      <div class="skeleton-text short"></div>
                    </div>
                  </div>
                </div>
                <div class="similar-products-grid" id="results-container" style="display: none;"></div>
              </div>
            </div>
          `;

          contentArea.insertBefore(visualSearchContainer, contentArea.firstChild);
          
          setTimeout(() => {
            setupImageHotspots();
            setupCustomCropSelection();
          }, 500);
          

          const apiServer = 'https://ipshopy.com/api';

          
          const fetchUrl = `${apiServer}/get_search_results/${sessionId}`;

          
          fetch(fetchUrl, {
            method: 'GET',
            credentials: 'omit',
            headers: {
              'Accept': 'application/json'
            },
            timeout: 10000
          })
            .then(response => {

              if (!response.ok) {
                return response.text().then(text => {
                  console.error('Error response:', text);
                  throw new Error(`Server returned ${response.status}: ${text}`);
                });
              }
              return response.json();
            })
            .then(data => {
              const results = data.results || [];
              const uploadedImageUrl = data.uploaded_image_url || '';
              const message = data.message || (results.length === 0 ? 'No similar products found.' : '');
              
              // Clear the skeleton timeout since results loaded successfully
              if (window.skeletonTimeout) {
                clearTimeout(window.skeletonTimeout);
                window.skeletonTimeout = null;
              }
              
              const skeletonLoader = document.getElementById('skeleton-loader');
              const imageSkeletonLoader = document.getElementById('image-skeleton');
              const resultsContainer = document.getElementById('results-container');
              
              // Clear the message update interval if it exists
              if (skeletonLoader && skeletonLoader.dataset.intervalId) {
                clearInterval(parseInt(skeletonLoader.dataset.intervalId));
                
                // Show completion message before hiding
                const messageElement = document.getElementById('skeleton-message');
                if (messageElement) {
                  messageElement.textContent = "Search complete! Showing results...";
                }
                
                // Set progress bar to 100%
                const progressBar = document.getElementById('skeleton-progress-bar');
                if (progressBar) {
                  progressBar.style.width = '100%';
                }
                
                // Short delay before hiding
                setTimeout(() => {
                  // Hide both skeleton loaders
                  if (skeletonLoader) skeletonLoader.style.display = 'none';
                  if (imageSkeletonLoader) imageSkeletonLoader.style.display = 'none';
                  
                  // Show results container
                  if (resultsContainer) resultsContainer.style.display = 'grid';
                }, 500);
              } else {
                // Hide both skeleton loaders immediately if no interval
                if (skeletonLoader) skeletonLoader.style.display = 'none';
                if (imageSkeletonLoader) imageSkeletonLoader.style.display = 'none';
                
                // Show results container
                if (resultsContainer) resultsContainer.style.display = 'grid';
              }

              const uploadedImageContainer = document.getElementById('uploaded-image-container');
              if (uploadedImageUrl) {
                uploadedImageContainer.innerHTML += `
                  <div class="uploaded-image-container">
                    <div class="image-wrapper" id="image-wrapper">
                      <img src="${uploadedImageUrl}" alt="Uploaded Image" class="uploaded-image" id="uploaded-search-image" onerror="this.src='image/placeholder.png'; this.alt='Image failed to load';" />
                    </div>
                    <div class="image-controls">
                      <span class="control-label">Translate</span>
                      <span class="control-label">Text</span>
                    </div>
                  </div>
                `;
              }

              if (results && results.length > 0) {
                // Store all results for pagination
                window.allSearchResults = results;
                
                // Set items per page to 20
                const itemsPerPage = 20;
                
                // Start with page 1
                const currentPage = 1;
                
                // Calculate total pages
                const totalPages = Math.ceil(results.length / itemsPerPage);
                
                // Get results for the first page
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, results.length);
                const pageResults = results.slice(startIndex, endIndex);
                
                let productsHTML = '';
                
                // Generate HTML for the current page results
                pageResults.forEach(result => {
                  const productUrl = result.product_id ? 
                    `index.php?route=product/product&product_id=${result.product_id}` : 
                    (result.url || '#');
                  
                  const mrpPrice = result.mrp_price ? parseFloat(result.mrp_price).toFixed(2) : '';
                  const specialPrice = result.special_price ? parseFloat(result.special_price).toFixed(2) : '';
                  
                  const productName = result.product_name ? result.product_name : (result.filename || 'Product');
                  
                  // Limit product name to 25 characters with ellipsis if longer
                  const truncatedName = productName.length > 25 ? productName.substring(0, 25) + '...' : productName;
                  
                  // Calculate discount percentage if not provided but we have both prices
                  const discountPercentage = result.discount_percentage || 
                    (specialPrice && mrpPrice ? Math.round((mrpPrice - specialPrice) / mrpPrice * 100) : null);
                  
                  productsHTML += `
                    <div class="product-card">
                      ${discountPercentage ? `<div class="discount-badge">-${discountPercentage}%</div>` : ''}
                      <div class="product-image-container">
                        <a href="${productUrl}">
                          <img src="${result.image_url || result.image}" alt="${productName}" class="product-image">
                        </a>
                      </div>
                      <div class="product-details">
                        <h4 class="product-name">${truncatedName}</h4>
                        <div class="price-container">
                          ${specialPrice ? 
                            `<span class="product-price">₹${specialPrice}</span>
                             <span class="product-mrp">₹${mrpPrice}</span>` 
                            : 
                            `<span class="product-price">${mrpPrice ? `₹${mrpPrice}` : ''}</span>`
                          }
                        </div>
                      </div>
                      
                      <div class="hover-actions">
                        ${result.product_id ? `<button class="add-to-cart-btn" data-product-id="${result.product_id}"><i class="fa fa-shopping-cart"></i></button>` : ''}
                        <div class="action-icon wishlist"><i class="fa fa-heart-o"></i></div>
                        <div class="action-icon compare"><i class="fa fa-exchange"></i></div>
                      </div>
                    </div>
                  `;
                });
                
                // Add pagination if there are multiple pages
                if (totalPages > 1) {
                  productsHTML += generatePaginationHTML(currentPage, totalPages);
                }
                
                resultsContainer.innerHTML = productsHTML;
                
                // Setup pagination event listeners
                if (totalPages > 1) {
                  setupPaginationListeners(results, itemsPerPage);
                }
              } else {
                resultsContainer.innerHTML = `<p>${message}</p>`;
              }
            })
            .catch(error => {
              console.error('Error fetching search results:', error);
              // Hide both skeleton loaders
              const skeletonLoader = document.getElementById('skeleton-loader');
              const imageSkeletonLoader = document.getElementById('image-skeleton');
              const resultsContainer = document.getElementById('results-container');
              
              if (skeletonLoader) skeletonLoader.style.display = 'none';
              if (imageSkeletonLoader) imageSkeletonLoader.style.display = 'none';
              
              if (resultsContainer) {
                resultsContainer.style.display = 'block';
                resultsContainer.innerHTML = `<p>Error loading search results: ${error.message}</p>`;
              }
            });
        } catch (err) {
          alert("Failed to display visual search results: " + err.message);
        }
      }
    })();
    
    function setupEventListeners() {
      setupVisualSearchModal();
      setupPhotoCapturing();
      setupDragAndDrop();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
    });
    
    function setupImageHotspots() {
      const imageWrapper = document.getElementById('image-wrapper');
      const uploadedImage = document.getElementById('uploaded-search-image');
      
      if (!imageWrapper || !uploadedImage) {

        return;
      }
      
      document.querySelectorAll('.image-hotspot, .image-selection-outline, .hotspot-tooltip').forEach(el => el.remove());
      
      const hotspotPositions = [
        { left: 35, top: 45, width: 30, height: 30 },
        { left: 65, top: 45, width: 30, height: 30 },
      ];
      
      const positionHotspots = function() {
        const imgRect = uploadedImage.getBoundingClientRect();
        const wrapperRect = imageWrapper.getBoundingClientRect();
        
        const offsetX = (wrapperRect.width - imgRect.width) / 2;
        const offsetY = (wrapperRect.height - imgRect.height) / 2;
        
        hotspotPositions.forEach((pos, index) => {
          const hotspot = document.createElement('div');
          hotspot.className = 'image-hotspot';
          hotspot.dataset.index = index;
          
          const dotLeft = offsetX + (imgRect.width * pos.left / 100);
          const dotTop = offsetY + (imgRect.height * pos.top / 100);
          
          hotspot.style.left = dotLeft + 'px';
          hotspot.style.top = dotTop + 'px';
          
          const outline = document.createElement('div');
          outline.className = 'image-selection-outline';
          outline.dataset.index = index;
          
          const outlineWidth = imgRect.width * pos.width / 100;
          const outlineHeight = imgRect.height * pos.height / 100;
          outline.style.width = outlineWidth + 'px';
          outline.style.height = outlineHeight + 'px';
          outline.style.left = (dotLeft - outlineWidth/2) + 'px';
          outline.style.top = (dotTop - outlineHeight/2) + 'px';
          
          const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
          corners.forEach(position => {
            const corner = document.createElement('div');
            corner.className = `crop-corner ${position}`;
            outline.appendChild(corner);
          });
          
          const tooltip = document.createElement('div');
          tooltip.className = 'hotspot-tooltip';
          tooltip.textContent = 'Click to search within the image';
          tooltip.style.left = dotLeft + 'px';
          tooltip.style.top = dotTop + 'px';
          
          hotspot.addEventListener('mouseenter', function() {
            tooltip.style.opacity = '1';
            outline.style.opacity = '0.8';
          });
          
          hotspot.addEventListener('mouseleave', function() {
            if (!hotspot.classList.contains('active')) {
              tooltip.style.opacity = '0';
              outline.style.opacity = '0';
            }
          });
          
          hotspot.addEventListener('click', function() {
            document.querySelectorAll('.image-hotspot').forEach(d => {
              d.classList.remove('active');
            });
            document.querySelectorAll('.image-selection-outline').forEach(o => {
              o.classList.remove('active');
            });
            document.querySelectorAll('.hotspot-tooltip').forEach(t => {
              t.style.opacity = '0';
            });
            
            this.classList.add('active');
            outline.classList.add('active');
            
            searchImageRegion(index);
          });
          
          imageWrapper.appendChild(outline);
          imageWrapper.appendChild(hotspot);
          imageWrapper.appendChild(tooltip);
        });
      };
      
      if (uploadedImage.complete) {
        positionHotspots();
      } else {
        uploadedImage.onload = positionHotspots;
      }
      
      window.addEventListener('resize', positionHotspots);
    }
    
    function setupCustomCropSelection() {
      const imageWrapper = document.getElementById('image-wrapper');
      const uploadedImage = document.getElementById('uploaded-search-image');
      
      if (!imageWrapper || !uploadedImage) return;
      
      let isSelecting = false;
      let startX, startY;
      let selectionElement = null;
      let cornerElements = [];
      
      function createCorners(parent) {
        cornerElements.forEach(corner => corner.remove());
        cornerElements = [];
        
        const positions = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
        positions.forEach(position => {
          const corner = document.createElement('div');
          corner.className = `crop-corner ${position}`;
          parent.appendChild(corner);
          cornerElements.push(corner);
        });
      }
      
      imageWrapper.addEventListener('mousedown', function(e) {
        const imgRect = uploadedImage.getBoundingClientRect();
        const wrapperRect = imageWrapper.getBoundingClientRect();
        
        const offsetX = e.clientX - wrapperRect.left;
        const offsetY = e.clientY - wrapperRect.top;
        
        const imageLeft = (wrapperRect.width - imgRect.width) / 2;
        const imageTop = (wrapperRect.height - imgRect.height) / 2;
        const imageRight = imageLeft + imgRect.width;
        const imageBottom = imageTop + imgRect.height;
        
        if (offsetX >= imageLeft && offsetX <= imageRight && 
            offsetY >= imageTop && offsetY <= imageBottom) {
          const existingSelections = document.querySelectorAll('.custom-selection-area');
          existingSelections.forEach(el => el.remove());
          
          document.querySelectorAll('.image-hotspot').forEach(d => {
            d.classList.remove('active');
          });
          document.querySelectorAll('.image-selection-outline').forEach(o => {
            o.classList.remove('active');
          });
          
          isSelecting = true;
          startX = offsetX;
          startY = offsetY;
          
          selectionElement = document.createElement('div');
          selectionElement.className = 'custom-selection-area';
          selectionElement.style.left = startX + 'px';
          selectionElement.style.top = startY + 'px';
          selectionElement.style.width = '0';
          selectionElement.style.height = '0';
          imageWrapper.appendChild(selectionElement);
          
          createCorners(selectionElement);
          
          e.preventDefault();
        }
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isSelecting || !selectionElement) return;
        
        const wrapperRect = imageWrapper.getBoundingClientRect();
        const currentX = e.clientX - wrapperRect.left;
        const currentY = e.clientY - wrapperRect.top;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        
        const left = Math.min(startX, currentX);
        const top = Math.min(startY, currentY);
        
        selectionElement.style.width = width + 'px';
        selectionElement.style.height = height + 'px';
        selectionElement.style.left = left + 'px';
        selectionElement.style.top = top + 'px';
        
        e.preventDefault();
      });
      
      document.addEventListener('mouseup', function(e) {
        if (isSelecting && selectionElement) {
          isSelecting = false;
          
          const width = parseInt(selectionElement.style.width);
          const height = parseInt(selectionElement.style.height);
          
          if (width < 20 || height < 20) {
            selectionElement.remove();
            return;
          }
          
          const imgRect = uploadedImage.getBoundingClientRect();
          const wrapperRect = imageWrapper.getBoundingClientRect();
          
          const imageLeft = (wrapperRect.width - imgRect.width) / 2;
          const imageTop = (wrapperRect.height - imgRect.height) / 2;
          
          const selLeft = parseInt(selectionElement.style.left) - imageLeft;
          const selTop = parseInt(selectionElement.style.top) - imageTop;
          const selRight = selLeft + width;
          const selBottom = selTop + height;
          
          const relativeCoords = {
            left: (selLeft / imgRect.width * 100).toFixed(2),
            top: (selTop / imgRect.height * 100).toFixed(2),
            right: (selRight / imgRect.width * 100).toFixed(2),
            bottom: (selBottom / imgRect.height * 100).toFixed(2),
            width: (width / imgRect.width * 100).toFixed(2),
            height: (height / imgRect.height * 100).toFixed(2)
          };
          

          
          const instruction = document.createElement('div');
          instruction.className = 'selection-instruction';
          instruction.textContent = 'Click to search within the image';
          instruction.style.left = (parseInt(selectionElement.style.left) + width/2 - 100) + 'px';
          instruction.style.top = (parseInt(selectionElement.style.top) - 40) + 'px';
          imageWrapper.appendChild(instruction);
          
          selectionElement.style.pointerEvents = 'auto';
          selectionElement.style.cursor = 'pointer';
          
          selectionElement.addEventListener('click', function() {
            instruction.remove();
            searchCustomImageRegion(relativeCoords);
          });
          
          imageWrapper.addEventListener('click', function clickHandler(e) {
            if (!e.target.classList.contains('image-hotspot')) {
              instruction.remove();
              searchCustomImageRegion(relativeCoords);
              imageWrapper.removeEventListener('click', clickHandler);
            }
          }, { once: true });
        }
      });
    }
    
    function searchImageRegion(regionIndex) {

      updateResultsDisplay();
    }
    
    function searchCustomImageRegion(coords) {

      
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session_id');
      
      if (!sessionId) {
        console.error('No session ID found for crop search');
        return;
      }
      
      const resultsContainer = document.getElementById('results-container');
      if (resultsContainer) {
        resultsContainer.style.opacity = '0.6';
      }
      
      const apiServer = 'https://ipshopy.com/api';
      const searchUrl = `${apiServer}/search_region/${sessionId}`;
      
      fetch(searchUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          crop_coordinates: coords
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}`);
        }
        return response.json();
      })
      .then(data => {

        
        if (data.results && data.results.length > 0) {
          updateResultsWithNewData(data.results);
        } else {
          updateResultsDisplay('custom');
        }
      })
      .catch(error => {
        console.error('Error searching region:', error);
        updateResultsDisplay('custom');
      });
    }
    
    function updateResultsDisplay(type = 'hotspot') {
      const resultsContainer = document.getElementById('results-container');
      if (!resultsContainer) return;
      
      resultsContainer.style.opacity = '0.6';
      
      setTimeout(() => {
        const productCards = resultsContainer.querySelectorAll('.product-card');
        if (productCards.length > 0) {
          const productsArray = Array.from(productCards);
          
          for (let i = productsArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [productsArray[i].style.order, productsArray[j].style.order] = 
            [productsArray[j].style.order, productsArray[i].style.order];
            
            productsArray[i].style.opacity = (0.7 + Math.random() * 0.3).toFixed(2);
          }
          
          const highlightColor = type === 'custom' ? 
            'rgba(0, 174, 239, 0.6)' : 'rgba(0, 174, 239, 0.6)';
          
          for (let i = 0; i < Math.min(3, productsArray.length); i++) {
            productsArray[i].style.boxShadow = `0 0 15px ${highlightColor}`;
            setTimeout(() => {
              productsArray[i].style.boxShadow = '';
            }, 1500);
          }
        }
        
        resultsContainer.style.opacity = '1';
      }, 700);
    }
    
    function updateResultsWithNewData(results) {
      const resultsContainer = document.getElementById('results-container');
      if (!resultsContainer) return;
      
      const itemsPerPage = 20;
      const totalPages = Math.ceil(results.length / itemsPerPage);
      const currentPage = 1;
      
      let productsHTML = '';
      
      results.forEach(result => {
        const productUrl = result.product_id ? 
          `index.php?route=product/product&product_id=${result.product_id}` : 
          (result.url || '#');
        
        const mrpPrice = result.mrp_price ? parseFloat(result.mrp_price).toFixed(2) : '';
        const specialPrice = result.special_price ? parseFloat(result.special_price).toFixed(2) : '';
        
        const productName = result.product_name ? result.product_name : (result.filename || 'Product');
        
        productsHTML += `
          <div class="product-card">
            ${result.discount_percentage ? 
              `<div class="discount-badge">-${result.discount_percentage}%</div>` : ''}
            <div class="product-image-container">
              <a href="${productUrl}">
                <img src="${result.image_url || result.image}" alt="${productName}" class="product-image">
              </a>
            </div>
            <div class="product-details">
              <h4 class="product-name">${productName}</h4>
              <div class="price-container">
                ${specialPrice ? 
                  `<span class="product-price">₹${specialPrice}</span>
                  <span class="product-mrp">₹${mrpPrice}</span>` 
                  : 
                  `<span class="product-price">${mrpPrice ? `₹${mrpPrice}` : ''}</span>`}
              </div>
            </div>
            <div class="hover-actions">
              ${result.product_id ? `<button class="add-to-cart-btn" data-product-id="${result.product_id}"><i class="fa fa-shopping-cart"></i></button>` : ''}
              <div class="action-icon wishlist"><i class="fa fa-heart-o"></i></div>
              <div class="action-icon compare"><i class="fa fa-exchange"></i></div>
            </div>
          </div>
        `;
      });
      
      resultsContainer.style.opacity = '0.3';
      
      if (totalPages > 1) {
        productsHTML += generatePaginationHTML(currentPage, totalPages);
      }
      
      setTimeout(() => {
        resultsContainer.innerHTML = productsHTML;
        
        const newProducts = resultsContainer.querySelectorAll('.product-card');
        newProducts.forEach(product => {
          product.style.boxShadow = '0 0 15px rgba(0, 174, 239, 0.6)';
          setTimeout(() => {
            product.style.boxShadow = '';
          }, 1500);
        });
        
        setupPaginationListeners(results, itemsPerPage);
        
        resultsContainer.style.opacity = '1';
      }, 400);
    }
    
    function generatePaginationHTML(currentPage, totalPages) {
      let paginationHTML = `
        <div class="pagination-container">
          <div class="pagination">
      `;
      
      // Previous page arrow
      if (currentPage > 1) {
        paginationHTML += `<a href="#" class="page-link" data-page="${currentPage - 1}">&laquo;</a>`;
      } else {
        paginationHTML += `<a href="#" class="page-link" style="visibility: hidden;">&laquo;</a>`;
      }
      
      // First page
      paginationHTML += `<a href="#" class="page-link ${currentPage === 1 ? 'active' : ''}" data-page="1">1</a>`;
      
      // Page numbers
      const maxVisiblePages = 5; // Show 5 page numbers at a time
      let startPage = Math.max(2, currentPage - 1);
      let endPage = Math.min(totalPages - 1, startPage + 2);
      
      // Adjust start page if we're near the end
      if (endPage - startPage < 2 && startPage > 2) {
        startPage = Math.max(2, endPage - 2);
      }
      
      // Add ellipsis if needed before middle pages
      if (startPage > 2) {
        paginationHTML += `<span class="page-ellipsis">...</span>`;
      }
      
      // Generate middle page links
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<a href="#" class="page-link ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>`;
      }
      
      // Add ellipsis if needed after middle pages
      if (endPage < totalPages - 1) {
        paginationHTML += `<span class="page-ellipsis">...</span>`;
      }
      
      // Last page (if not already included)
      if (totalPages > 1) {
        paginationHTML += `<a href="#" class="page-link ${currentPage === totalPages ? 'active' : ''}" data-page="${totalPages}">${totalPages}</a>`;
      }
      
      // Next page arrow
      if (currentPage < totalPages) {
        paginationHTML += `<a href="#" class="page-link" data-page="${currentPage + 1}">&raquo;</a>`;
      } else {
        paginationHTML += `<a href="#" class="page-link" style="visibility: hidden;">&raquo;</a>`;
      }
      
      paginationHTML += `
          </div>
          <div class="pagination-info">Showing ${(currentPage-1)*20+1} to ${Math.min(currentPage * 20, window.allSearchResults.length)} of ${window.allSearchResults.length} items</div>
        </div>
      `;
      
      return paginationHTML;
    }
    
    function setupPaginationListeners(allResults, itemsPerPage) {
      const pageLinks = document.querySelectorAll('.page-link');
      pageLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = parseInt(this.dataset.page);
          updatePageContent(allResults, page, itemsPerPage);
        });
      });
    }
    
    function updatePageContent(allResults, page, itemsPerPage) {
      const resultsContainer = document.getElementById('results-container');
      if (!resultsContainer) return;
      
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, allResults.length);
      const pageResults = allResults.slice(startIndex, endIndex);
      
      // Fade out the container before updating
      resultsContainer.style.opacity = '0.5';
      
      let productsHTML = '';
      pageResults.forEach(result => {
        const productUrl = result.product_id ? 
          `index.php?route=product/product&product_id=${result.product_id}` : 
          (result.url || '#');
        
        const mrpPrice = result.mrp_price ? parseFloat(result.mrp_price).toFixed(2) : '';
        const specialPrice = result.special_price ? parseFloat(result.special_price).toFixed(2) : '';
        
        const productName = result.product_name ? result.product_name : (result.filename || 'Product');
        
        productsHTML += `
          <div class="product-card">
            ${result.discount_percentage ? 
              `<div class="discount-badge">-${result.discount_percentage}%</div>` : ''}
            <div class="product-image-container">
              <a href="${productUrl}">
                <img src="${result.image_url || result.image}" alt="${productName}" class="product-image">
              </a>
            </div>
            <div class="product-details">
              <h4 class="product-name">${productName}</h4>
              <div class="price-container">
                ${specialPrice ? 
                  `<span class="product-price">₹${specialPrice}</span>
                  <span class="product-mrp">₹${mrpPrice}</span>` 
                  : 
                  `<span class="product-price">${mrpPrice ? `₹${mrpPrice}` : ''}</span>`}
              </div>
            </div>
            <div class="hover-actions">
              ${result.product_id ? `<button class="add-to-cart-btn" data-product-id="${result.product_id}"><i class="fa fa-shopping-cart"></i></button>` : ''}
              <div class="action-icon wishlist"><i class="fa fa-heart-o"></i></div>
              <div class="action-icon compare"><i class="fa fa-exchange"></i></div>
            </div>
          </div>
        `;
      });
      
      const totalPages = Math.ceil(allResults.length / itemsPerPage);
      if (totalPages > 1) {
        productsHTML += generatePaginationHTML(page, totalPages);
      }
      
      resultsContainer.innerHTML = productsHTML;
      
      // Setup pagination event listeners
      setupPaginationListeners(allResults, itemsPerPage);
      
      // Fade in the container after updating
      setTimeout(() => {
        resultsContainer.style.opacity = '1';
        
        // Ensure hover effects work after page change
        document.querySelectorAll('.product-card').forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.querySelector('.hover-actions').style.display = 'flex';
          });
          
          card.addEventListener('mouseleave', function() {
            this.querySelector('.hover-actions').style.display = 'none';
          });
        });
      }, 300);
      
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
  });

  // Drag and Drop functionality
  document.addEventListener('DOMContentLoaded', function() {
    const interactionBox = document.querySelector('.interaction-box');
    const fileInput = document.getElementById('fileInput');
    
    if (!interactionBox || !fileInput) return;
    
    // Setup file input change event
    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        handleFiles(this.files);
      }
    });
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      interactionBox.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
      interactionBox.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      interactionBox.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    interactionBox.addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function highlight() {
      interactionBox.classList.add('drag-over');
    }
    
    function unhighlight() {
      interactionBox.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length) {
        handleFiles(files);
      } else if (dt.items) {
        // Handle drag from browser
        for (let i = 0; i < dt.items.length; i++) {
          if (dt.items[i].kind === 'file') {
            const file = dt.items[i].getAsFile();
            if (file) {
              const fileArray = [file];
              handleFiles(fileArray);
              break;
            }
          } else if (dt.items[i].kind === 'string' && dt.items[i].type.match('^text/uri-list')) {
            // Handle image URLs
            dt.items[i].getAsString(url => {
              if (url && isValidImageUrl(url)) {
                fetchImageFromUrl(url);
              }
            });
            break;
          }
        }
      }
    }
    
    function handleFiles(files) {
      if (files.length) {
        const file = files[0]; // Use first file only
        if (!file.type.match('image.*')) {
          alert('Please drop an image file.');
          return;
        }
        
        // Show the unified loading animation
        showFullPageLoading('Processing your image...');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageBase64 = e.target.result;
          document.getElementById('image-base64').value = imageBase64;
          
          // Submit the form or process the image
          processUploadedImage(imageBase64);
        };
        reader.readAsDataURL(file);
      }
    }
    
    function isValidImageUrl(url) {
      return url.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i) !== null;
    }
    
    function fetchImageFromUrl(url) {
      // Show the unified loading animation
      showFullPageLoading('Fetching image from URL...');
      
      fetch(url)
        .then(response => response.blob())
        .then(blob => {
          const reader = new FileReader();
          reader.onloadend = function() {
            document.getElementById('image-base64').value = reader.result;
            processUploadedImage(reader.result);
          };
          reader.readAsDataURL(blob);
        })
        .catch(error => {
          console.error('Error fetching image:', error);
          hideFullPageLoading();
          alert('Could not load the image. Please try another URL or upload directly.');
        });
    }
    
    function showLoadingIndicator() {
      // Create and show loading indicator
      let loadingContainer = document.getElementById('loading-indicator');
      
      if (!loadingContainer) {
        loadingContainer = document.createElement('div');
        loadingContainer.id = 'loading-indicator';
        loadingContainer.className = 'loading-container';
        loadingContainer.innerHTML = `
          <div class="loading-animation">
            <div class="loading-dots">
              <div class="dot dot-blue"></div>
              <div class="dot dot-red"></div>
              <div class="dot dot-yellow"></div>
            </div>
            <div class="loading-text" id="loading-message">Analyzing your image...</div>
          </div>
        `;
        
        // Add the loading styles if they don't exist
        if (!document.getElementById('loading-styles')) {
          const style = document.createElement('style');
          style.id = 'loading-styles';
          style.textContent = `
            .loading-container {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(255, 255, 255, 0.9);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 9999;
            }
            
            .loading-animation {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 15px;
            }
            
            .loading-dots {
              display: flex;
              gap: 8px;
            }
            
            .dot {
              width: 10px;
              height: 10px;
              border-radius: 50%;
              animation: bounce 1.4s infinite ease-in-out both;
            }
            
            .dot-blue {
              background-color: #4285F4;
              animation-delay: -0.32s;
            }
            
            .dot-red {
              background-color: #EA4335;
              animation-delay: -0.16s;
            }
            
            .dot-yellow {
              background-color: #FBBC05;
              animation-delay: 0s;
            }
            
            .loading-text {
              color: #1a73e8;
              font-size: 16px;
              font-weight: 500;
              text-align: center;
              min-height: 48px;
            }
            
            @keyframes bounce {
              0%, 80%, 100% { transform: scale(0.4); }
              40% { transform: scale(1.0); }
            }

            .progress-bar-container {
              width: 250px;
              height: 6px;
              background-color: #e0e0e0;
              border-radius: 3px;
              margin-top: 15px;
              overflow: hidden;
            }
            
            .progress-bar {
              height: 100%;
              background-color: #4285F4;
              width: 0%;
              border-radius: 3px;
              transition: width 0.5s ease;
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(loadingContainer);

        // Add progress bar
        const loadingAnimation = loadingContainer.querySelector('.loading-animation');
        const progressBarContainer = document.createElement('div');
        progressBarContainer.className = 'progress-bar-container';
        progressBarContainer.innerHTML = '<div class="progress-bar" id="loading-progress-bar"></div>';
        loadingAnimation.appendChild(progressBarContainer);

        // Set up sequence of messages
        const loadingMessages = [
          "Analyzing your image...",
          "Looking for similar products...",
          "Matching colors and patterns...",
          "Finding best matches...",
          "Almost done! Preparing results...",
          "Loading Visual Search Result..."
        ];
        
        let messageIndex = 0;
        let progress = 0;
        
        // Update loading message and progress bar
        const messageElement = document.getElementById('loading-message');
        const progressBar = document.getElementById('loading-progress-bar');
        
        const updateMessage = setInterval(() => {
          messageIndex = (messageIndex + 1) % loadingMessages.length;
          if (messageElement) {
            messageElement.textContent = loadingMessages[messageIndex];
            
            // Update progress
            progress += (100 - progress) * 0.2;
            if (progressBar) {
              progressBar.style.width = Math.min(progress, 95) + '%';
            }
          }
        }, 2000);
        
        // Store the interval ID so we can clear it later
        loadingContainer.dataset.intervalId = updateMessage;
        
      } else {
        loadingContainer.style.display = 'flex';
        
        // Reset progress bar
        const progressBar = document.getElementById('loading-progress-bar');
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        
        // Restart message sequence
        const messageElement = document.getElementById('loading-message');
        if (messageElement) {
          messageElement.textContent = "Analyzing your image...";
        }
      }
      
      // Hide the modal while loading using Bootstrap 3.3.5 method
      $('#visualSearchModal').modal('hide');
    }
    
    function hideLoadingIndicator() {
      const loadingContainer = document.getElementById('loading-indicator');
      if (loadingContainer) {
        // Clear the message update interval
        if (loadingContainer.dataset.intervalId) {
          clearInterval(parseInt(loadingContainer.dataset.intervalId));
        }
        
        // Set progress to 100% before hiding
        const progressBar = document.getElementById('loading-progress-bar');
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        
        // Update message to completion
        const messageElement = document.getElementById('loading-message');
        if (messageElement) {
          messageElement.textContent = "Search complete!";
        }
        
        // Fade out and hide after a short delay
        setTimeout(() => {
          loadingContainer.style.opacity = '0';
          setTimeout(() => {
            loadingContainer.style.display = 'none';
          }, 300);
        }, 500);
      }
    }
    
    function processUploadedImage(imageData) {
      // Show unified loading animation  
      showFullPageLoading('Processing your image... Please wait');
      
      // Convert base64 to blob
      const byteString = atob(imageData.split(',')[1]);
      const mimeString = imageData.split(',')[0].split(':')[1].split(';')[0];
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      
      const blob = new Blob([ab], {type: mimeString});
      const formData = new FormData();
      formData.append('file', blob, 'dropped_image.jpg');
      
      // Step 1: Upload image and get session ID
      fetch('https://www.ipshopy.com/api/search_by_image', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'Error processing image');
          });
        }
        return response.json();
      })
      .then(data => {
        // Check if the response contains a session_id for fetching results
        if (!data.success || !data.session_id) {
          throw new Error('Invalid response from server');
        }
      
        const sessionId = data.session_id;
        const uploadedImageUrl = data.uploaded_image_url;
        
        // Store these values for later use
        window.visualSearchSessionId = sessionId;
        
        // Step 2: Fetch the actual search results using session ID
        return fetch(`https://ipshopy.com/api/get_search_results/${sessionId}`)
          .then(response => {
            if (!response.ok) {
              return response.json().then(errorData => {
                throw new Error(errorData.error || 'Error fetching search results');
              });
            }
            return response.json().then(resultsData => {
              // Add the uploaded image URL and session ID to the results
              resultsData.query_image = uploadedImageUrl;
              resultsData.session_id = sessionId; // Make sure session ID is passed along
              return resultsData;
            });
          });
      })
      .then(finalResults => {
        hideFullPageLoading();
        
        // Make sure the session ID is present in the final results
        if (!finalResults.session_id && window.visualSearchSessionId) {
          finalResults.session_id = window.visualSearchSessionId;
        }
        
        redirectToSearchResults(finalResults);
      })
      .catch(error => {
        console.error('Error processing image:', error);
        hideFullPageLoading();
        alert(error.message || 'There was an error processing your image. Please try again.');
      });
    }
  
  // Function to handle search results and redirect to the product search page
  function redirectToSearchResults(data) {

    
    // Hide loading indicator
    hideLoadingIndicator();
    
    // First try to get session ID from the global variable we set earlier
    let sessionId = window.visualSearchSessionId || '';

    
    // If not found, try to get it from the data object
    if (!sessionId && data) {
      if (data.session_id) {
        sessionId = data.session_id;

      } else if (typeof data === 'object') {
        // Try to find the session_id property at any level
        const findSessionId = (obj, depth = 0) => {
          if (depth > 3) return null; // Prevent too deep recursion
          
          for (const key in obj) {
            if (key === 'session_id' && typeof obj[key] === 'string' && obj[key]) {
              return obj[key];
            } else if (typeof obj[key] === 'object' && obj[key] !== null) {
              const found = findSessionId(obj[key], depth + 1);
              if (found) return found;
            }
          }
          return null;
        };
        
        const foundId = findSessionId(data);
        if (foundId) {
          sessionId = foundId;

        }
      }
    }
    

    
    // Fallback if we still don't have a session ID
    if (!sessionId) {
      console.warn('No session ID found. Using generated UUID as fallback.');
      sessionId = 'gen_' + Math.random().toString(36).substring(2, 15);
    }
    
    // Count the number of results if available
    let resultCount = 1000; // Default value
    if (data.result_count) {
      resultCount = data.result_count;
    } else if (data.results && Array.isArray(data.results)) {
      resultCount = data.results.length;
    } else if (data.products && Array.isArray(data.products)) {
      resultCount = data.products.length;
    }
    
    // Check if fromRefPage exists in the data
    const fromRefPage = data.fromRefPage || '';
    
    // Create the redirect URL to the search page
    let searchUrl = `https://localhost/sagar/index.php?route=product%2Fvisual_search&session_id=${sessionId}&result_count=${resultCount}&search=visual&category_id=0&submit_search=`;
    
    // Add fromRefPage parameter if it exists
    if (fromRefPage) {
      searchUrl += `&fromRefPage=${encodeURIComponent(fromRefPage)}`;
    }
    
    // Create a form to POST the session_id to make sure it's properly sent
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'https://localhost/sagar/index.php?route=product%2Fvisual_search';
    
    // Add hidden fields for all the parameters
    const addField = (name, value) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    };
    
    addField('session_id', sessionId);
    addField('result_count', resultCount);
    addField('search', 'visual');
    addField('category_id', '0');
    addField('submit_search', 'true');
    
    // Add fromRefPage if it exists
    if (fromRefPage) {
      addField('fromRefPage', fromRefPage);
    }
    
    // Add the form to the document and submit it
    document.body.appendChild(form);
    form.submit();
    
    // As a fallback, also try the redirect method
    setTimeout(() => {
      window.location.href = searchUrl;
    }, 500);
    
    // No additional processing needed since we're redirecting to the search page
  }
  
  // Setup interactive hotspots on the image
  function setupImageHotspots(results) {
    const container = document.getElementById('hotspot-container');
    const image = document.getElementById('query-image');
    
    if (!container || !image) {

      return;
    }
    

    
    // Clear any existing hotspots
    const existingHotspots = container.querySelectorAll('.image-hotspot');
    existingHotspots.forEach(spot => spot.remove());
    
    // Add click event to create hotspots
    image.addEventListener('click', function(e) {

      
      // Remove any existing hotspots
      const existingHotspots = container.querySelectorAll('.image-hotspot');
      existingHotspots.forEach(spot => spot.remove());
      
      // Get click coordinates relative to the image
      const rect = image.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Calculate percentage position
      const percentX = (x / image.width) * 100;
      const percentY = (y / image.height) * 100;
      

      
      // Create hotspot
      const hotspot = document.createElement('div');
      hotspot.className = 'image-hotspot';
      hotspot.style.left = `${percentX}%`;
      hotspot.style.top = `${percentY}%`;
      container.appendChild(hotspot);
      
      // Here we would typically send a new search request with the specific coordinates
      // For now, let's just refresh the current results
      // In a real implementation, you would send these coordinates to the server
      // and get back results for that specific part of the image
      if (Array.isArray(results) && results.length > 0) {

        // Simulate filtering results based on the clicked area
        // In a real implementation, this would be a new API call
        const filteredResults = [...results].sort(() => Math.random() - 0.5).slice(0, Math.max(4, Math.floor(results.length / 2)));
        
        // Update the products display
        updateProductsDisplay(filteredResults);
      } else {

      }
    });
  }
  
  // Update products display based on filtered results
  function updateProductsDisplay(results) {
    const productsGrid = document.getElementById('similar-products-grid');
    
    if (!productsGrid || !results) return;
    
    // Clear existing products
    productsGrid.innerHTML = '';
    
    // Display products in a grid
    results.forEach(product => {
      // Calculate discount percentage if both prices exist
      let discountPercentage = '';
      if (product.sale_price && product.original_price) {
        const originalPrice = parseFloat(product.original_price.replace(/[^0-9.]/g, ''));
        const salePrice = parseFloat(product.sale_price.replace(/[^0-9.]/g, ''));
        if (!isNaN(originalPrice) && !isNaN(salePrice) && originalPrice > salePrice) {
          const discount = Math.round(((originalPrice - salePrice) / originalPrice) * 100);
          discountPercentage = `<span class="discount-badge">-${discount}%</span>`;
        }
      }
      
      // Determine availability class
      const availabilityClass = product.in_stock ? 'in-stock' : 'out-of-stock';
      const availabilityText = product.in_stock ? 'In Stock' : 'Out of Stock';
      
      // Create product card
      const productCard = `
        <div class="col-md-3 col-sm-6 mb-4">
          <div class="product-card">
            ${discountPercentage}
            <div class="product-image">
              <img src="${product.image_url}" alt="${product.title}">
            </div>
            <div class="product-info">
              <h5 class="product-title">${product.title}</h5>
              <div class="product-price">
                ${product.original_price ? `<span class="original-price">${product.original_price}</span>` : ''}
                <span class="regular-price">${product.sale_price || product.price || ''}</span>
              </div>
              <div class="similarity">Similarity: ${Math.round(product.similarity_score * 100)}%</div>
              <div class="action-buttons mt-2">
                <button class="btn btn-sm btn-primary add-to-cart-btn">Add to Cart</button>
                <button class="btn btn-sm btn-outline-secondary view-product-btn">View</button>
              </div>
              <div class="availability ${availabilityClass}">${availabilityText}</div>
            </div>
          </div>
        </div>
      `;
      
      productsGrid.innerHTML += productCard;
    });
  }
});

</script>


		
	{{ footer }}
