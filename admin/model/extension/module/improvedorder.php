<?php class ModelExtensionModuleImprovedorder extends Model{public function getOrderStatusColor($order_status_id){$this->createOrderStatusColor();$query=$this->db->query("SELECT * FROM ".DB_PREFIX."order_status_color WHERE order_status_id = '".(int)$order_status_id."'");if($query->num_rows){return $query->row;}else{return array('bg'=>'#fff','fc'=>'#000');}}public function createOrderStatusColor(){if(!$this->db->query("SHOW COLUMNS FROM `".DB_PREFIX."option_value` LIKE  'bg'")->num_rows){$this->db->query("ALTER TABLE `".DB_PREFIX."option_value` ADD  `bg` varchar(32) NOT NULL,ADD `fc` varchar(32) NOT NULL");}if(!$this->db->query("SHOW COLUMNS FROM `".DB_PREFIX."order_option` LIKE  'option_value_id'")->num_rows){$this->db->query("ALTER TABLE `".DB_PREFIX."order_option` ADD  `option_value_id` int(11) NOT NULL");}if($this->db->query("SHOW TABLES LIKE '".DB_PREFIX."order_status_color'")->num_rows==0){$sql="CREATE TABLE IF NOT EXISTS `".DB_PREFIX."order_status_color` (`order_status_id` int(11) NOT NULL,`bg` VARCHAR(32) NOT NULL,`fc` varchar(32) NOT NULL) ENGINE=MyISAM  DEFAULT CHARSET=utf8";$this->db->query($sql);}}public function savePhoneNo($order_id,$telephone){$this->db->query("UPDATE  ".DB_PREFIX."order SET telephone =  '".$this->db->escape($telephone)."', date_modified = NOW() WHERE order_id = '".(int)$order_id."'");}public function getOrderProducts($order_id,$currency_code,$currency_value){$productarray=array();if($this->config->get("module_improvedorder_productpurchased")){$this->load->model('tool/upload');$this->load->model('tool/image');$this->load->model('sale/order');$productarray=array();$products=$this->model_sale_order->getOrderProducts($order_id);foreach($products as $product){$productquery=$this->db->query("SELECT model,mpn, sku,upc,location,image FROM  ".DB_PREFIX."product where product_id = '".$product['product_id']."' ");$width=$height=50;$bg="#fff";$fc="#000";if($this->config->get("module_improvedorder_imagesizewidth")&&$this->config->get("module_improvedorder_imagesizeheigth")){$width=$this->config->get("module_improvedorder_imagesizewidth");$height=$this->config->get("module_improvedorder_imagesizeheigth");}$image=$this->model_tool_image->resize('no_image.png',$width,$height);if($productquery->num_rows){if(is_file(DIR_IMAGE.$productquery->row['image'])){$image=$this->model_tool_image->resize($productquery->row['image'],$width,$height);}}$option_data=array();$options=$this->model_sale_order->getOrderOptions($order_id,$product['order_product_id']);foreach($options as $option){if(isset($option['option_value_id'])&&$option['option_value_id']){$optioncolorquery=$this->db->query("SELECT bg,fc FROM  ".DB_PREFIX."option_value where option_value_id = '".$option['option_value_id']."' AND bg != '' AND fc != '' AND bg != fc ");if($optioncolorquery->num_rows){$bg=$optioncolorquery->row['bg'];$fc=$optioncolorquery->row['fc'];}}if($option['type']!='file'){$option_data[]=array('name'=>$option['name'],'value'=>$option['value'],'type'=>$option['type']);}else{$upload_info=$this->model_tool_upload->getUploadByCode($option['value']);if($upload_info){$option_data[]=array('name'=>$option['name'],'value'=>$upload_info['name'],'type'=>$option['type'],'href'=>$this->url->link('tool/upload/download','user_token='.$this->session->data['user_token'].'&code='.$upload_info['code'],TRUE));}}}$total=$this->currency->format($product['total'],$currency_code,$currency_value);$extrafieldstring=$this->config->get("module_improvedorder_extraproductfields");if(!empty($extrafieldstring)){$extrafieldstring=preg_replace("/\s+/","",$extrafieldstring);$extrafieldstring=strtolower($extrafieldstring);$extrafieldarray=explode(",",$extrafieldstring);foreach($extrafieldarray as $key=>$value){if(isset($productquery->row[$value])&&$productquery->row[$value]){$product['name'].='<br>'.$value.": ".$productquery->row[$value];}}}$productarray[]=array('name'=>$product['name'].'<br> Total: '.$total,'image'=>$image,'option'=>$option_data,'bg'=>$bg,'fc'=>$fc,'quantity'=>$product['quantity'],'href'=>$this->url->link('catalog/product/edit','user_token='.$this->session->data['user_token'].'&product_id='.$product['product_id'],TRUE));}}return $productarray;}public function getTotalOrderProducts($order_id){$totalProductCount=0;if($this->config->get("module_improvedorder_totalproductcount")){$this->load->model('sale/order');$products=$this->model_sale_order->getOrderProducts($order_id);foreach($products as $product){$totalProductCount+=$product['quantity'];}}return $totalProductCount;}public function getImprovedOrderDetails($order_id){$this->createOrderStatusColor();$query=$this->db->query("SELECT osc.bg, osc.fc,o.comment,o.customer_id,o.order_id,o.payment_method,o.shipping_method,o.email,o.telephone,o.order_status_id,o.store_name FROM `".DB_PREFIX."order` o LEFT JOIN `".DB_PREFIX."order_status_color` osc ON (o.order_status_id = osc.order_status_id) WHERE o.order_id = '".(int)$order_id."'");$query->row['totalorders']='';if($this->config->get('module_improvedorder_totalnoorders')){if(isset($query->row['email'])){$query->row['totalorders']=$this->getTotalNoOfOrders($query->row['email']);}}if(isset($query->row['customer_id'])&&$query->row['customer_id']){$query->row['customerhref']=$this->url->link('customer/customer/edit','user_token='.$this->session->data['user_token'].'&customer_id='.$query->row['customer_id'],true);}else{$query->row['customerhref']="";}return $query->row;}public function getTotalNoOfOrders($email){$query=$this->db->query("SELECT COUNT(*) as total FROM `".DB_PREFIX."order` o WHERE o.email = '".$this->db->escape($email)."' AND o.order_status_id > 0");return $query->row['total'];}public function getAddressDetails($order_id){$query=$this->db->query("SELECT o.shipping_firstname,o.shipping_lastname,o.shipping_company,o.shipping_address_1,o.shipping_address_2,o.shipping_city,o.shipping_postcode, o.shipping_country,o.shipping_zone,o.shipping_custom_field FROM `".DB_PREFIX."order` o WHERE o.order_id = '".(int)$order_id."'");$shipping_custom_fields=array();if($query->row['shipping_custom_field']){$query->row['shipping_custom_field']=json_decode($query->row['shipping_custom_field'],true);$custom_fields=$this->getCustomFields();foreach($custom_fields as $custom_field){if($custom_field['location']=='address'&&isset($query->row['shipping_custom_field'][$custom_field['custom_field_id']])){if($custom_field['type']=='select'||$custom_field['type']=='radio'){$custom_field_value_info=$this->getCustomFieldValue($query->row['shipping_custom_field'][$custom_field['custom_field_id']]);if($custom_field_value_info){$shipping_custom_fields[]=array('name'=>$custom_field['name'],'value'=>$custom_field_value_info['name'],'sort_order'=>$custom_field['sort_order']);}}if($custom_field['type']=='checkbox'&&is_array($query->row['shipping_custom_field'][$custom_field['custom_field_id']])){foreach($query->row['shipping_custom_field'][$custom_field['custom_field_id']]as $custom_field_value_id){$custom_field_value_info=$this->getCustomFieldValue($custom_field_value_id);if($custom_field_value_info){$shipping_custom_fields[]=array('name'=>$custom_field['name'],'value'=>$custom_field_value_info['name'],'sort_order'=>$custom_field['sort_order']);}}}if($custom_field['type']=='text'||$custom_field['type']=='textarea'||$custom_field['type']=='file'||$custom_field['type']=='date'||$custom_field['type']=='datetime'||$custom_field['type']=='time'){$shipping_custom_fields[]=array('name'=>$custom_field['name'],'value'=>$query->row['shipping_custom_field'][$custom_field['custom_field_id']],'sort_order'=>$custom_field['sort_order']);}if($custom_field['type']=='file'){$this->load->model("tool/upload");$upload_info=$this->model_tool_upload->getUploadByCode($query->row['shipping_custom_field'][$custom_field['custom_field_id']]);if($upload_info){$shipping_custom_fields[]=array('name'=>$custom_field['name'],'value'=>$upload_info['name'],'sort_order'=>$custom_field['sort_order']);}}}}}$customfieldstring="";foreach($shipping_custom_fields as $custom_field){$customfieldstring=$custom_field['name'].': '.$custom_field['value'];}$find=array('{firstname}','{lastname}','{company}','{address_1}','{address_2}','{city}','{postcode}','{zone}','{country}','{custom_field}');$replace=array('firstname'=>$query->row['shipping_firstname'],'lastname'=>$query->row['shipping_lastname'],'company'=>$query->row['shipping_company'],'address_1'=>$query->row['shipping_address_1'],'address_2'=>$query->row['shipping_address_2'],'city'=>$query->row['shipping_city'],'postcode'=>$query->row['shipping_postcode'],'zone'=>$query->row['shipping_zone'],'country'=>$query->row['shipping_country'],'custom_field'=>$customfieldstring);$format=$this->config->get('module_improvedorder_shippingaddress');$shipping_address=str_replace(array("\r\n","\r","\n"),'<br />',preg_replace(array("/\s\s+/","/\r\r+/","/\n\n+/"),'<br />',trim(str_replace($find,$replace,$format))));return html_entity_decode($shipping_address);}public function getCustomFields($data=array()){if(empty($data['filter_customer_group_id'])){$sql="SELECT * FROM `".DB_PREFIX."custom_field` cf LEFT JOIN ".DB_PREFIX."custom_field_description cfd ON (cf.custom_field_id = cfd.custom_field_id) WHERE cfd.language_id = '".(int)$this->config->get('config_language_id')."'";}else{$sql="SELECT * FROM ".DB_PREFIX."custom_field_customer_group cfcg LEFT JOIN `".DB_PREFIX."custom_field` cf ON (cfcg.custom_field_id = cf.custom_field_id) LEFT JOIN ".DB_PREFIX."custom_field_description cfd ON (cf.custom_field_id = cfd.custom_field_id) WHERE cfd.language_id = '".(int)$this->config->get('config_language_id')."'";}$sql.=" ORDER BY cfd.name";$query=$this->db->query($sql);return $query->rows;}public function getCustomFieldValue($custom_field_value_id){$query=$this->db->query("SELECT * FROM ".DB_PREFIX."custom_field_value cfv LEFT JOIN ".DB_PREFIX."custom_field_value_description cfvd ON (cfv.custom_field_value_id = cfvd.custom_field_value_id) WHERE cfv.custom_field_value_id = '".(int)$custom_field_value_id."' AND cfvd.language_id = '".(int)$this->config->get('config_language_id')."'");return $query->row;}public function getTotalSalesByDateRange($date1,$date2){$orderstatusids=array_merge($this->config->get('config_processing_status'),$this->config->get('config_complete_status'));$orderstatusids=array_unique($orderstatusids);$orderstatusids=implode(",",$orderstatusids);$query=$this->db->query("SELECT SUM(total) AS total FROM `".DB_PREFIX."order` WHERE order_status_id IN (".$orderstatusids.") AND date(date_added) <=  '".$date2."' AND  date(date_added) >= '".$date1."'");return $query->row['total'];}public function getTotalSalesToday(){$orderstatusids=array_merge($this->config->get('config_processing_status'),$this->config->get('config_complete_status'));$orderstatusids=array_unique($orderstatusids);$orderstatusids=implode(",",$orderstatusids);$query=$this->db->query("SELECT SUM(total) AS total FROM `".DB_PREFIX."order` WHERE order_status_id  IN (".$orderstatusids.") AND date(date_added) = '".date('Y-m-d')."'");return $query->row['total'];}}