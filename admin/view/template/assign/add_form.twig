{{ header }}
{{ column_left }}

<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <h1>{{ heading_title }}</h1>
    </div>
  </div>

  <div class="container-fluid">
    <div class="panel panel-default" style="max-width: 800px; margin: 0 auto;">
     
      <div class="panel-body">
        <form action="{{ action }}" method="post" id="assign-form">
          <div class="form-group">
            <label for="user_id">User Name</label>
            <select name="user_id" class="form-control" required>
              {% for user in users %}
                <option value="{{ user.user_id }}">{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>

          {#<div class="form-group">#}
          {#  <label for="seller_id">Seller Name</label>#}
          {#  <div class="dropdown">#}
          {#    <button class="btn btn-default dropdown-toggle form-control" type="button" id="sellerDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">#}
          {#      Select Sellers <span class="caret pull-right" style="margin-top:8px;"></span>#}
          {#    </button>#}
          {#    <div class="dropdown-menu seller-dropdown-menu" aria-labelledby="sellerDropdown">#}
          {#      <div class="seller-list-wrapper">#}
          {#        <!-- Range Headers with Checkboxes and Sellers -->#}
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="1-10">#}
          {#            <span class="range-label">-- 1-10 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-1-10">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 1 and loop.index <= 10 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="1-10">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="11-20">#}
          {#            <span class="range-label">-- 11-20 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-11-20">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 11 and loop.index <= 20 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="11-20">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="21-30">#}
          {#            <span class="range-label">-- 21-30 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-21-30">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 21 and loop.index <= 30 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="21-30">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="31-40">#}
          {#            <span class="range-label">-- 31-40 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-31-40">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 31 and loop.index <= 40 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="31-40">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="41-50">#}
          {#            <span class="range-label">-- 41-50 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-41-50">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 41 and loop.index <= 50 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="41-50">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <!-- Range 51-60 -->#}
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="51-60">#}
          {#            <span class="range-label">-- 51-60 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-51-60">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 51 and loop.index <= 60 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="51-60">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <!-- Range 61-70 -->#}
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="61-70">#}
          {#            <span class="range-label">-- 61-70 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-61-70">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 61 and loop.index <= 70 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="61-70">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <!-- Range 71-80 -->#}
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="71-80">#}
          {#            <span class="range-label">-- 71-80 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-71-80">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 71 and loop.index <= 80 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="71-80">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
                  
          {#        <!-- Range 81-90 -->#}
          {#        <div class="range-header">#}
          {#          <label>#}
          {#            <input type="checkbox" class="range-checkbox" data-range="81-90">#}
          {#            <span class="range-label">-- 81-90 --</span>#}
          {#          </label>#}
          {#        </div>#}
          {#        <div class="seller-list" id="sellers-81-90">#}
          {#          {% for seller in sellers %}#}
          {#            {% if loop.index >= 81 and loop.index <= 90 %}#}
          {#              <div class="seller-item">#}
          {#                <label>#}
          {#                  <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox" data-range="81-90">#}
          {#                  {{ seller.seller_name }}#}
          {#                </label>#}
          {#              </div>#}
          {#            {% endif %}#}
          {#          {% endfor %}#}
          {#        </div>#}
          {#      </div>#}
          {#    </div>#}
          {#  </div>#}
          {#</div>#}
          
          <div class="form-group">
              <label for="seller_id">Seller Name</label>
              <div class="dropdown">
                <button class="btn btn-default dropdown-toggle form-control" type="button" id="sellerDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Select Sellers <span class="caret pull-right" style="margin-top:8px;"></span>
                </button>
               <div class="dropdown-menu seller-dropdown-menu" aria-labelledby="sellerDropdown">
              <!-- Search Input -->
              <div style="padding: 8px 10px; border-bottom: 1px solid #ccc;">
                <input type="text" class="form-control" id="seller-search" placeholder="Search seller...">
              </div>
            
              <!-- Seller List -->
              <div class="seller-list">
                    {% for seller in sellers %}
                      <div class="seller-item">
                        <label>
                          <input type="checkbox" name="seller_id[]" value="{{ seller.seller_id }}" class="seller-checkbox">
                          {{ seller.seller_name }} {{ seller.seller_lastname }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          
          <style>
            .seller-dropdown-container {
              border: 1px solid #ddd;
              border-radius: 4px;
              padding: 15px;
              background-color: #f9f9f9;
            }
            
            .seller-list-wrapper {
              max-height: 400px;
              overflow-y: auto;
              border: 1px solid #ddd;
              border-radius: 4px;
              background-color: #fff;
              width: 100%;
            }
            
            /* Make dropdown wider */
            .dropdown-menu.seller-dropdown-menu {
              width: 100%;
              padding: 0;
              max-height: none;
            }
            
            .range-header {
              padding: 10px 15px;
              background-color: #f5f5f5;
              cursor: pointer;
              border-bottom: 1px solid #ddd;
              position: sticky;
              top: 0;
              z-index: 10;
            }
            
            .range-header:hover {
              background-color: #e9e9e9;
            }
            
            .range-header.selected-range {
              background-color: #e8f5e9;
              border-color: #5cb85c;
            }
            
            .range-header label {
              display: flex;
              align-items: center;
              margin-bottom: 0;
              width: 100%;
              cursor: pointer;
              font-weight: bold;
            }
            
            .range-header input[type="checkbox"] {
              margin-right: 10px;
            }
            
            .range-label {
              flex-grow: 1;
            }
            
            /*.seller-list {
              padding: 0;
              background-color: #fff;
            }
            
            .seller-item {
              padding: 8px 15px 8px 35px;
              border-bottom: 1px solid #f5f5f5;
              transition: background-color 0.2s;
            }*/
            
            /* added code changes on 12-07-2025   --*/
            .seller-list {
              max-height: 180px; /* Shows approx. 5 sellers */
              overflow-y: auto;
              background-color: #fff;
              border: 1px solid #ddd;
              border-radius: 4px;
              padding: 5px 0;
            }

            .seller-item {
              padding: 8px 15px 8px 35px;
              border-bottom: 1px solid #f5f5f5;
              transition: background-color 0.2s;
            }
            /*----------endhere---------------*/
            
            .seller-item:hover {
              background-color: #f9f9f9;
            }
            
            .seller-item.selected {
              background-color: #e8f5e9;
            }
            
            .seller-item label {
              display: flex;
              align-items: center;
              margin-bottom: 0;
              cursor: pointer;
              width: 100%;
            }
            
            .seller-item input[type="checkbox"] {
              margin-right: 10px;
            }
          </style>
          
          <script type="text/javascript">
          $(document).ready(function() {
            // Cache selectors for better performance
            var $rangeCheckboxes = $('.range-checkbox');
            var $sellerCheckboxes = $('.seller-checkbox');
            var $rangeHeaders = $('.range-header');
            var $sellerLists = $('.seller-list');
            
            // Show all lists by default
            // $sellerLists.hide(); // Removed this line to show all lists
            
            // Prevent dropdown from closing when clicking inside it
            $(document).on('click', '.seller-dropdown-menu', function(e) {
              e.stopPropagation();
            });
            
            // Update dropdown text based on selections
            function updateDropdownText() {
              var selectedCount = $('.seller-checkbox:checked').length;
              var text = selectedCount > 0 ? selectedCount + ' sellers selected' : 'Select Sellers';
              $('#sellerDropdown').html(text + ' <span class="caret pull-right" style="margin-top:8px;"></span>');
            }
            
            // Handle range checkbox changes (Select All by Range)
            $rangeCheckboxes.on('change', function() {
              var $this = $(this);
              var range = $this.data('range');
              var isChecked = $this.prop('checked');
              
              // Update the selected-range class
              $this.closest('.range-header').toggleClass('selected-range', isChecked);
              
              // Check/uncheck all seller checkboxes in this range
              $('.seller-checkbox[data-range="' + range + '"]').prop('checked', isChecked);
              
              // Update the selected class for seller items
              updateSellerItemSelection();
              
              // Show/hide the seller list based on checkbox state
              if (isChecked) {
                $('#sellers-' + range).show();
              } else {
                $('#sellers-' + range).hide();
              }
              
              // Update dropdown text
              updateDropdownText();
            });
            
            // Make the range headers clickable (toggle checkbox when clicked)
            $rangeHeaders.on('click', function(e) {
              // Only handle clicks directly on the header (not on the checkbox itself)
              if (!$(e.target).is('input[type="checkbox"]')) {
                var $checkbox = $(this).find('input[type="checkbox"]');
                $checkbox.prop('checked', !$checkbox.prop('checked')).trigger('change');
              }
            });
            
            // Function to update the selected class on seller items
            function updateSellerItemSelection() {
              $('.seller-item').each(function() {
                var $checkbox = $(this).find('input[type="checkbox"]');
                $(this).toggleClass('selected', $checkbox.prop('checked'));
              });
            }
            
            // Helper function to check if all sellers in a range are checked
            function areAllSellersInRangeChecked(range) {
              var $sellersInRange = $('.seller-checkbox[data-range="' + range + '"]');
              var $checkedSellersInRange = $sellersInRange.filter(':checked');
              return $sellersInRange.length === $checkedSellersInRange.length;
            }
            
            // Handle individual seller checkbox changes
            $sellerCheckboxes.on('change', function() {
              var range = $(this).data('range');
              var allChecked = areAllSellersInRangeChecked(range);
              
              // Update range checkbox state and class
              var $rangeCheckbox = $('.range-checkbox[data-range="' + range + '"]');
              $rangeCheckbox.prop('checked', allChecked);
              $rangeCheckbox.closest('.range-header').toggleClass('selected-range', allChecked);
              
              // Update the selected class
              updateSellerItemSelection();
              
              // Update dropdown text
              updateDropdownText();
            });
          });
          
        //   --- added changes for the assign work on 12-07-2025
          $('#seller-search').on('keyup', function () {
              var value = $(this).val().toLowerCase();
              $('.seller-item').filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
              });
            });
        // ----------------------------------------------------------
          </script>

          <div class="form-group" style="text-align: center;">
            <button type="submit" class="btn btn-primary">
              <i class="fa fa-save"></i> Assign
            </button>
          </div>

          <a href="{{ back_url }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"
             style="position: absolute; top: 10px; right: 20px; width: 30px; height: 30px; padding: 0;
                    display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 6px;">
            <i class="fa fa-reply" style="font-size: 18px; color: #444;"></i>
          </a>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
  $('#assign-form').on('submit', function(e) {
    e.preventDefault();
    
    $.ajax({
      url: $(this).attr('action'),
      type: 'POST',
      data: $(this).serialize(),
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          window.location.href = '{{ back_url }}';
        } else if (json.error) {
          alert(json.error);
        }
      },
      error: function() {
        // If AJAX fails, submit form normally
        $('#assign-form')[0].submit();
      }
    });
  });
});
</script>

{{ footer }}